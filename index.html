<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutoring Hub - Making Maths & Science Make Sense</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Agora Web SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base Styles */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        :root {
            --primary-color: #2c3e50;
            --secondary-color: #007bff;
            --accent-color: #28a745;
            --danger-color: #dc3545;
            --text-dark: #333;
            --text-light: #f4f4f4;
            --bg-light: #ffffff;
            --bg-dark: #f8f9fa;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --chat-primary: #e3f2fd;
            --chat-secondary: #f5f5f5;
        }

        /* Custom styles not available in Tailwind */
        .header-logo {
            filter: brightness(0) invert(1);
        }

        h1, h2, h3 {
            font-family: 'Roboto Slab', serif;
        }

        .btn {
            display: inline-block;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

            .btn:hover {
                transform: translateY(-2px);
            }

        .hero-image {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .about-content img {
            border: 5px solid var(--secondary-color);
            box-shadow: 0 5px 15px var(--shadow-light);
        }

        .about-content .achievements span {
            background-color: var(--secondary-color);
        }

        .tutor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .why-item {
            border-left: 4px solid var(--secondary-color);
        }

        .pricing-content ul li {
            box-shadow: 0 2px 5px var(--shadow-light);
        }

        .testimonial-item::before {
            content: "“";
            font-size: 4em;
            color: var(--secondary-color);
            position: absolute;
            top: 10px;
            left: 20px;
            opacity: 0.2;
            line-height: 0.5;
        }

        .contact-form input, .contact-form textarea {
            width: calc(100% - 20px);
        }

        .modal {
            display: none;
        }

            .modal.flex {
                display: flex;
            }

        .chat-tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }

        .schedule-tab.active {
            background-color: #3b82f6;
            color: white;
        }

        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }

            .fade-in.appear {
                opacity: 1;
                transform: translateY(0);
            }

        @media (min-width: 600px) {
            .about-content {
                flex-direction: row;
                text-align: left;
                align-items: flex-start;
            }

                .about-content img {
                    margin-right: 30px;
                }

                .about-content .bio {
                    flex: 1;
                }
        }
    </style>
</head>
<body class="bg-gray-100">

    <header class="bg-blue-950 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center px-4">
            <div class="flex items-center gap-2 mb-4 md:mb-0">
                <img src="https://placehold.co/100x100/2c3e50/ffffff?text=TH" alt="Tutoring Hub Logo" class="w-12 h-12 rounded-full header-logo">
                <h1 class="text-3xl font-bold font-['Roboto_Slab']">Tutoring Hub</h1>
            </div>
            <nav class="main-nav">
                <ul class="flex flex-col md:flex-row gap-4 md:gap-8 text-lg font-semibold">
                    <li><a href="#" id="home-link" class="hover:text-blue-400 transition-colors">Home</a></li>
                    <li><a href="#about" class="hover:text-blue-400 transition-colors">About Us</a></li>
                    <li><a href="#tutors" class="hover:text-blue-400 transition-colors">Our Tutors</a></li>
                    <li><a href="#contact" class="hover:text-blue-400 transition-colors">Contact</a></li>
                    <li><a href="#" id="login-link" class="hover:text-blue-400 transition-colors">Login</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <!-- Hero Section -->
        <section class="hero bg-white text-gray-800 text-center p-8 md:p-16 shadow-inner fade-in">
            <div class="container mx-auto px-4">
                <img src="https://placehold.co/1200x400/e3f2fd/2c3e50?text=Online+Tutoring+Session" alt="Students and tutors collaborating online" class="hero-image w-full rounded-lg mb-8">
                <h1 class="text-4xl md:text-5xl font-bold font-['Roboto_Slab'] text-blue-950 mb-4">Find Your Perfect Tutor. Excel in Any Subject.</h1>
                <p class="text-lg md:text-xl max-w-3xl mx-auto mb-8 text-gray-700">Whether you're a high school student aiming for distinctions, or a varsity student tackling advanced modules, our platform is your key to academic success. We connect you with a network of verified tutors who are ready to turn confusion into clarity and build lasting confidence. 🎓</p>
                <a href="#tutors" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Find Your Tutor Today!</a>
            </div>
        </section>

        <!-- About Us Section -->
        <section id="about" class="bg-white p-12 md:p-24 border-b border-gray-200 fade-in">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl md:text-4xl font-bold font-['Roboto_Slab'] text-blue-950 mb-8 text-center md:text-left">About us</h2>
                <div class="about-content flex flex-col md:flex-row items-center gap-8">
                    <img src="https://placehold.co/180x180/2c3e50/ffffff?text=Team" alt="Tutoring Hub Team" class="w-48 h-48 rounded-full object-cover border-4 border-blue-500 shadow-md">
                    <div class="bio text-center md:text-left">
                        <p class="text-lg mb-4 text-gray-700"><strong>Tutoring Hub</strong> is a South African-based academic support platform dedicated to empowering learners from high school to university. Supported by a team of educators, developers, and curriculum specialists, our mission is to make STEM subjects accessible, engaging, and achievable for all students.</p>
                        <div class="achievements mt-4">
                            <h3 class="text-xl font-bold font-['Roboto_Slab'] text-gray-800">What Sets Us Apart:</h3>
                            <div class="flex flex-wrap justify-center md:justify-start gap-2 mt-2">
                                <span class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-full text-sm">Expert Tutors with Proven Academic Records</span>
                                <span class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-full text-sm">AI-Enhanced Learning Tools</span>
                                <span class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-full text-sm">Flexible Online & In-Person Tutoring</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tutors Section -->
        <section id="tutors" class="bg-gray-100 p-12 md:p-24 fade-in">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl md:text-4xl font-bold font-['Roboto_Slab'] text-blue-950 mb-8 text-center">Our Tutors: Verified Experts Ready to Help</h2>
                <div id="tutor-grid" class="tutor-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Tutor cards will be dynamically inserted here -->
                </div>
            </div>
        </section>

        <!-- Contact Section -->
        <section id="contact" class="bg-white p-12 md:p-24 border-b border-gray-200 fade-in">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl md:text-4xl font-bold font-['Roboto_Slab'] text-blue-950 mb-8 text-center">
                    <span class="text-4xl align-middle">✉️</span> Ready to Find Your Perfect Tutor?
                </h2>
                <div class="contact-flex flex flex-col lg:flex-row gap-8 lg:gap-16">
                    <div class="contact-info fun-card bg-white rounded-2xl shadow-xl p-8 lg:p-10 border-2 border-blue-500 hover:transform hover:translate-y-[-4px] transition-all">
                        <h3 class="mt-0 text-2xl font-['Roboto_Slab'] text-blue-500">
                            <span class="text-2xl">🤝</span> Let's Connect!
                        </h3>
                        <p class="text-gray-700 mt-4">Get in touch with our support team if you have any questions or need assistance with the platform.</p>
                        <p class="mt-4 text-gray-700"><span class="text-blue-950 mr-2">📞</span> <strong>Phone/WhatsApp:</strong> <a href="tel:+27635321092" class="text-blue-500 hover:underline">+27 635321092</a></p>
                        <p class="mt-2 text-gray-700"><span class="text-blue-950 mr-2">📧</span> <strong>Email:</strong> <a href="mailto:msiguqu@gmail.com" class="text-blue-500 hover:underline">support@tutoringhub.com</a></p>
                        <p class="mt-2 text-gray-700"><span class="text-blue-950 mr-2">⏰</span> <strong>Support Hours:</strong> Mon-Fri: 9 AM - 5 PM</p>
                    </div>

                    <div id="contactFormContainer" class="fun-card bg-white rounded-2xl shadow-xl p-8 lg:p-10 border-2 border-blue-500 hover:transform hover:translate-y-[-4px] transition-all">
                        <h3 class="mt-0 text-xl font-['Roboto_Slab'] text-blue-500">
                            <span class="text-2xl"></span> Send Us a Message
                        </h3>
                        <form id="contact-form" action="https://formspree.io/f/xrbkprno" method="POST" class="contact-form mt-4">
                            <div class="mb-4">
                                <label for="name" class="block mb-2 font-bold text-blue-950">Your Name:</label>
                                <input type="text" id="name" name="name" required class="w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="email" class="block mb-2 font-bold text-blue-950">Your Email:</label>
                                <input type="email" id="email" name="_replyto" required class="w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="message" class="block mb-2 font-bold text-blue-950">Your Message:</label>
                                <textarea id="message" name="message" rows="5" required class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                            </div>
                            <button type="submit" class="w-full btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">🚀 Send Message</button>
                        </form>
                        <p id="form-status" class="mt-4 text-center font-semibold text-lg"></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Login/Signup Modal -->
        <div id="auth-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-[2000]">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md relative">
                <span class="close-modal absolute top-4 right-6 text-3xl text-gray-500 cursor-pointer">&times;</span>
                <div class="auth-tabs flex mb-6 border-b-2 border-gray-200">
                    <div class="auth-tab flex-1 text-center py-3 text-lg cursor-pointer border-b-4 border-transparent font-semibold text-gray-500 hover:text-blue-500 transition-colors" data-tab="login">Login</div>
                    <div class="auth-tab flex-1 text-center py-3 text-lg cursor-pointer border-b-4 border-transparent font-semibold text-gray-500 hover:text-blue-500 transition-colors" data-tab="signup">Sign Up</div>
                </div>

                <form id="login-form" class="auth-form">
                    <div class="mb-4">
                        <label for="login-email" class="sr-only">Email</label>
                        <input type="email" id="login-email" placeholder="Email (e.g., alice@tutor.com)" required class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="sr-only">Password</label>
                        <input type="password" id="login-password" placeholder="Password" required class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <button type="submit" class="w-full btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg">Login</button>
                </form>

                <form id="signup-form" class="auth-form hidden">
                    <div class="mb-4">
                        <label for="signup-name" class="sr-only">Full Name</label>
                        <input type="text" id="signup-name" placeholder="Full Name" required class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div class="mb-4">
                        <label for="signup-email" class="sr-only">Email</label>
                        <input type="email" id="signup-email" placeholder="Email" required class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div class="mb-4">
                        <label for="signup-password" class="sr-only">Password</label>
                        <input type="password" id="signup-password" placeholder="Password" required class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div class="mb-6">
                        <label for="user-role" class="sr-only">Select Role</label>
                        <select id="user-role" required class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                            <option value="">Select Role</option>
                            <option value="student">Student</option>
                            <option value="tutor">Tutor</option>
                        </select>
                    </div>

                    <!-- Dynamic Module & Document Upload Section -->
                    <div id="role-specific-signup" class="mt-4 hidden p-4 border rounded-lg bg-gray-50">
                        <!-- Content will be inserted by JS -->
                    </div>

                    <button type="submit" class="w-full btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg mt-6">Sign Up</button>
                </form>

                <div id="seeded-users-container" class="mt-6 pt-4 border-t border-gray-200">
                    <h4 class="font-['Roboto_Slab'] text-blue-950 text-sm mb-2 text-center">Quick Logins (For Testing)</h4>
                    <div id="seeded-users-buttons" class="flex flex-wrap gap-2 justify-center">
                        <!-- Buttons will be inserted here by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard container mx-auto px-4 py-8 hidden">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-8">
                <h2 class="text-3xl font-bold font-['Roboto_Slab'] text-blue-950 mb-4 sm:mb-0">Welcome, <span id="user-name">User</span>!</h2>
                <div class="flex items-center gap-4">
                    <span id="user-id" class="text-sm text-gray-500 break-all"></span>
                    <div class="user-avatar w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-lg" id="user-avatar">U</div>
                    <button id="logout-btn" class="btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Logout</button>
                </div>

            </div>

            <nav class="dashboard-nav bg-white p-4 rounded-lg shadow-md mb-6">
                <ul class="flex flex-wrap gap-4">
                    <li class="hidden"><a href="#dashboard-home" class="nav-link py-2 px-4 rounded-lg text-blue-950 hover:bg-blue-500 hover:text-white transition-colors">Dashboard</a></li>
                    <li class="hidden" id="admin-management-link"><a href="#admin-management" class="nav-link py-2 px-4 rounded-lg text-blue-950 hover:bg-blue-500 hover:text-white transition-colors">Admin Panel</a></li>
                    <li class="hidden"><a href="#chat-section" class="nav-link py-2 px-4 rounded-lg text-blue-950 hover:bg-blue-500 hover:text-white transition-colors">Chat</a></li>
                    <li class="hidden"><a href="#video-call" class="nav-link py-2 px-4 rounded-lg text-blue-950 hover:bg-blue-500 hover:text-white transition-colors">Video Call</a></li>
                    <li class="hidden"><a href="#schedule" class="nav-link py-2 px-4 rounded-lg text-blue-950 hover:bg-blue-500 hover:text-white transition-colors">Schedule</a></li>
                    <li class="hidden"><a href="#resources" class="nav-link py-2 px-4 rounded-lg text-blue-950 hover:bg-blue-500 hover:text-white transition-colors">Resources</a></li>
                    <li class="hidden" id="student-management-link"><a href="#student-management" class="nav-link py-2 px-4 rounded-lg text-blue-950 hover:bg-blue-500 hover:text-white transition-colors">Students</a></li>
                    <li class="hidden"><a href="#reviews" class="nav-link py-2 px-4 rounded-lg text-blue-950 hover:bg-blue-500 hover:text-white transition-colors">Reviews</a></li>
                    <li class="hidden" id="ai-tutor-link"><a href="#ai-tutor-section" class="nav-link py-2 px-4 rounded-lg text-blue-950 hover:bg-blue-500 hover:text-white transition-colors">AI Tutor</a></li>
                </ul>
            </nav>

            <div id="dashboard-home" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <h3 class="text-2xl font-bold font-['Roboto_Slab'] text-blue-950 mb-4">Your Dashboard</h3>
                <div id="dashboard-content" class="text-gray-700"></div>

            </div>

            <!-- User Management
            <h4 class="text-xl font-bold text-blue-950 mb-4">Manage Users</h4>
            <div id="admin-user-list" class="flex flex-col gap-4">
                <!-- Example User Card
                <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg shadow-sm">
                    <div>
                        <p class="font-bold">Alice Johnson (alice@tutor.com)</p>
                        <p class="text-sm text-gray-600">Role: Tutor | Status: Approved</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded">Approve</button>
                        <button class="btn bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded">Suspend</button>
                        <button class="btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">Reset Password</button>
                    </div>
                </div>
            </div>
            -->


            <div id="admin-management" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <h3 class="text-2xl font-bold font-['Roboto_Slab'] text-blue-950 mb-4">User Management</h3>
                <div id="admin-content">
                    <!-- Tutor Assignment -->
                    <h4 class="text-xl font-bold text-blue-950 mt-8 mb-4">Assign Tutors to Students</h4>
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <form id="tutor-assignment-form" class="flex flex-col md:flex-row gap-4">
                            <select id="student-select" class="p-3 border rounded-lg flex-1">
                                <option value="">Select Student</option>
                            </select>
                            <select id="tutor-select" class="p-3 border rounded-lg flex-1">
                                <option value="">Select Tutor</option>
                            </select>
                            <button type="submit" class="btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Assign</button>
                        </form>
                        <div id="assignment-list" class="mt-4 text-sm text-gray-700"></div>
                    </div>
                    <!-- Sessions Overview -->
                    <h4 class="text-xl font-bold text-blue-950 mt-8 mb-4">Scheduled Sessions</h4>
                    <div id="admin-sessions" class="flex flex-col gap-3">
                        <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg shadow-sm">
                            <span><strong>Student:</strong> Sarah | <strong>Tutor:</strong> Alice | <strong>Date:</strong> 2025-09-08</span>
                            <div class="flex gap-2">
                                <button class="btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">Cancel</button>
                                <button class="btn bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded">Details</button>
                            </div>
                        </div>
                    </div>
                    <!-- Review Management -->
                    <h4 class="text-xl font-bold text-blue-950 mt-8 mb-4">Review Management</h4>
                    <div id="admin-reviews" class="flex flex-col gap-3">
                        <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg shadow-sm">
                            <span><strong>Alice</strong> received a 5★ review: "Great tutor!"</span>
                            <button class="btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">Delete</button>
                        </div>
                    </div>
                    <!-- Resource Management -->
                    <h4 class="text-xl font-bold text-blue-950 mt-8 mb-4">Manage Learning Resources</h4>
                    <div class="bg-gray-100 p-4 rounded-lg flex flex-col gap-4">
                        <form id="resource-upload-form" class="flex flex-col md:flex-row gap-4">
                            <input type="text" placeholder="Resource Title" class="p-3 border rounded-lg flex-1">
                            <input type="url" placeholder="Resource Link" class="p-3 border rounded-lg flex-1">
                            <button type="submit" class="btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">Add Resource</button>
                        </form>
                        <div id="resource-list" class="mt-4 text-sm text-gray-700"></div>
                    </div>
                    <!-- Announcements -->
                    <h4 class="text-xl font-bold text-blue-950 mt-8 mb-4">Announcements</h4>
                    <form id="announcement-form" class="flex flex-col md:flex-row gap-4 mb-4">
                        <input type="text" placeholder="Write announcement..." class="p-3 border rounded-lg flex-1">
                        <button type="submit" class="btn bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg">Post</button>
                    </form>
                    <div id="announcement-list" class="flex flex-col gap-2 text-sm text-gray-700">
                        <div class="bg-gray-100 p-3 rounded-lg shadow-sm">📢 Welcome to Tutoring Hub!</div>
                    </div>
                </div>
            </div>

            <div id="chat-section" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <h3 class="text-2xl font-bold font-['Roboto_Slab'] text-blue-950 mb-4">Chat</h3>
                <div class="flex border-b border-gray-300 mb-4">
                    <button id="dm-tab" class="chat-tab flex-1 py-2 text-center font-semibold text-gray-600 border-b-2 border-transparent active">Direct Messages</button>
                    <button id="group-tab" class="chat-tab flex-1 py-2 text-center font-semibold text-gray-600 border-b-2 border-transparent">Group Chats</button>
                </div>
                <div class="chat-container flex flex-col sm:flex-row h-[600px] border border-gray-300 rounded-lg overflow-hidden">
                    <div class="w-full sm:w-1/3 border-b sm:border-b-0 sm:border-r border-gray-300 overflow-y-auto">
                        <div id="chat-contacts-container">
                            <!-- Direct message contacts dynamically loaded -->
                        </div>
                        <div id="group-chat-contacts-container" class="hidden">
                            <!-- Group chat contacts dynamically loaded -->
                        </div>
                    </div>
                    <div class="chat-messages w-full sm:w-2/3 flex flex-col">
                        <div id="chat-header" class="p-4 border-b border-gray-300 bg-gray-100 font-semibold text-gray-800 flex justify-between items-center">
                            <span>Select a contact</span>
                            <div id="chat-header-buttons" class="flex gap-2">
                                <!-- Buttons like video call and review will be added here -->
                            </div>
                        </div>
                        <div id="chat-display" class="flex-1 p-4 overflow-y-auto flex flex-col-reverse gap-2">
                            <p class="text-center text-gray-500 mt-5">Select a contact to start chatting.</p>
                        </div>
                        <form id="chat-input-form" class="p-4 border-t border-gray-300 bg-gray-100 hidden flex items-center">
                            <input type="text" id="chat-message-input" placeholder="Type your message..." class="flex-1 p-3 border border-gray-300 rounded-full mr-2">
                            <button type="submit" id="send-message-btn" class="bg-blue-500 hover:bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center transition-colors"><i class="fas fa-paper-plane"></i></button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="video-call" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <h3 class="text-2xl font-bold font-['Roboto_Slab'] text-blue-950 mb-1">Video Call</h3>
                <p id="session-context-header" class="text-gray-600 mb-4">No active session.</p>
                <div class="flex flex-col gap-4">
                    <div>
                        <label for="agora-key-input" class="block text-sm font-medium text-gray-700">Enter Your Agora App ID:</label>
                        <div class="mt-1 flex gap-2">
                            <input type="text" id="agora-key-input" placeholder="Your Agora App ID" class="flex-1 p-3 border border-gray-300 rounded-lg">
                            <button id="save-agora-key-btn" class="btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Save</button>
                        </div>
                    </div>
                </div>
                <div class="video-call-container flex flex-col lg:flex-row gap-6 mt-6">
                    <div class="video-window flex-1 flex flex-col gap-4 min-h-[400px]">
                        <div id="local-player-container" class="video-player-container flex-1 bg-black rounded-lg relative overflow-hidden">
                            <div id="local-player" class="w-full h-full"></div>
                            <div class="absolute inset-0 flex items-center justify-center text-white text-lg pointer-events-none">Your Video</div>
                        </div>
                        <div id="remote-player-container" class="video-player-container flex-1 bg-black rounded-lg relative overflow-hidden">
                            <div id="remote-player" class="w-full h-full"></div>
                            <div class="absolute inset-0 flex items-center justify-center text-white text-lg pointer-events-none">Partner's Video</div>
                        </div>
                        <div class="video-controls flex justify-center gap-4 mt-4">
                            <button id="join-call-btn" class="w-12 h-12 rounded-full bg-blue-500 text-white text-xl flex items-center justify-center hover:bg-blue-600 transition-colors"><i class="fas fa-video"></i></button>
                            <button id="toggle-mic-btn" class="w-12 h-12 rounded-full bg-blue-500 text-white text-xl flex items-center justify-center hover:bg-blue-600 transition-colors hidden"><i class="fas fa-microphone"></i></button>
                            <button id="toggle-cam-btn" class="w-12 h-12 rounded-full bg-blue-500 text-white text-xl flex items-center justify-center hover:bg-blue-600 transition-colors hidden"><i class="fas fa-video"></i></button>
                            <button id="leave-call-btn" class="w-12 h-12 rounded-full bg-red-500 text-white text-xl flex items-center justify-center hover:bg-red-600 transition-colors hidden"><i class="fas fa-phone-slash"></i></button>
                        </div>
                        <div id="call-status" class="text-center text-gray-600 mt-2">Video call is not active.</div>
                    </div>
                    <!-- Session Chat -->
                    <div id="session-chat-container" class="w-full lg:w-1/3 flex flex-col border border-gray-300 rounded-lg min-h-[400px] hidden">
                        <div class="p-3 border-b bg-gray-100 font-semibold text-center">Session Chat</div>
                        <div id="session-chat-display" class="flex-1 p-4 overflow-y-auto flex flex-col-reverse gap-2"></div>
                        <form id="session-chat-form" class="p-2 border-t bg-gray-100 flex items-center">
                            <input type="text" id="session-chat-input" placeholder="Type message..." class="flex-1 p-2 border rounded-full mr-2">
                            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white rounded-full w-9 h-9 flex items-center justify-center flex-shrink-0"><i class="fas fa-paper-plane"></i></button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="schedule" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <h3 class="text-2xl font-bold font-['Roboto_Slab'] text-blue-950 mb-4">Your Schedule</h3>
                <div class="flex flex-col md:flex-row gap-8">
                    <div id="session-viewer" class="flex-1">
                        <!-- Tutor View -->
                        <div id="tutor-session-view">
                            <h4 class="text-xl font-bold font-['Roboto_Slab'] text-blue-950 mb-4">Upcoming Sessions</h4>
                            <div id="tutor-upcoming-list" class="bg-gray-100 p-4 rounded-lg"></div>
                        </div>
                        <!-- Student View -->
                        <div id="student-session-view" class="hidden">
                            <div class="flex bg-gray-200 rounded-lg p-1 mb-4">
                                <button class="schedule-tab flex-1 p-2 rounded-md font-semibold active" data-tab="upcoming">Upcoming</button>
                                <button class="schedule-tab flex-1 p-2 rounded-md font-semibold" data-tab="past">Past</button>
                            </div>
                            <div id="student-upcoming-list" class="schedule-content"></div>
                            <div id="student-past-list" class="schedule-content hidden"></div>
                        </div>
                    </div>
                    <div class="scheduling-form flex-1 bg-gray-100 p-6 rounded-lg">
                        <h4 id="schedule-form-title" class="text-xl font-bold font-['Roboto_Slab'] text-blue-950 mb-4">Book a Session</h4>
                        <form id="schedule-form">
                            <!-- Common fields -->
                            <div class="mb-4">
                                <label for="schedule-date" class="block mb-2 font-bold text-blue-950 text-sm">Date</label>
                                <input type="date" id="schedule-date" class="w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="schedule-time" class="block mb-2 font-bold text-blue-950 text-sm">Time Slot</label>
                                <select id="schedule-time" required class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                                    <option value="">Select a time slot...</option>
                                    <option value="08:00">8:00 AM</option>
                                    <option value="09:00">9:00 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="13:00">1:00 PM</option>
                                    <option value="14:00">2:00 PM</option>
                                    <option value="15:00">3:00 PM</option>
                                    <option value="16:00">4:00 PM</option>
                                    <option value="17:00">5:00 PM</option>
                                    <option value="18:00">6:00 PM</option>
                                    <option value="19:00">7:00 PM</option>
                                    <option value="20:00">8:00 PM</option>
                                </select>
                            </div>

                            <!-- Tutor-specific fields -->
                            <div id="tutor-schedule-fields" class="hidden">
                                <div class="mb-4">
                                    <label for="session-type" class="block mb-2 font-bold text-blue-950 text-sm">Session Type</label>
                                    <select id="session-type" class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                                        <option value="one-on-one">One-on-one</option>
                                        <option value="group">Group Session</option>
                                    </select>
                                </div>
                                <div id="one-on-one-fields">
                                    <div class="mb-4">
                                        <label for="one-on-one-topic" class="block mb-2 font-bold text-blue-950 text-sm">Topic</label>
                                        <input type="text" id="one-on-one-topic" placeholder="e.g., Introduction to Algebra" class="w-full p-3 border border-gray-300 rounded-lg">
                                    </div>
                                    <label for="schedule-student-select" class="block mb-2 font-bold text-blue-950 text-sm">Select a Student</label>
                                    <select id="schedule-student-select" class="w-full p-3 border border-gray-300 rounded-lg bg-white"></select>
                                </div>
                                <div id="group-fields" class="hidden">
                                    <div class="mb-4">
                                        <label for="group-topic" class="block mb-2 font-bold text-blue-950 text-sm">Topic</label>
                                        <input type="text" id="group-topic" placeholder="e.g., Calculus Basics" class="w-full p-3 border border-gray-300 rounded-lg">
                                    </div>
                                    <div class="mb-4">
                                        <label for="max-participants" class="block mb-2 font-bold text-blue-950 text-sm">Max Participants</label>
                                        <input type="number" id="max-participants" value="5" min="2" class="w-full p-3 border border-gray-300 rounded-lg">
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label for="tutor-schedule-notes" class="block mb-2 font-bold text-blue-950 text-sm">Notes</label>
                                    <textarea id="tutor-schedule-notes" placeholder="e.g., 'Chapter 5 review'" rows="4" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                                </div>
                            </div>

                            <button type="submit" class="w-full btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg">Schedule Session</button>
                        </form>
                    </div>
                </div>

                <div id="available-classes" class="mt-12">
                    <h4 class="text-xl font-bold font-['Roboto_Slab'] text-blue-950 mb-4">Available Group Sessions</h4>
                    <div id="available-group-session-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                <div id="pending-requests" class="mt-12 hidden">
                    <h4 class="text-xl font-bold font-['Roboto_Slab'] text-blue-950 mb-4">Pending Join Requests</h4>
                    <div id="pending-requests-list" class="flex flex-col gap-3">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>

            <div id="resources" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <h3 class="text-2xl font-bold font-['Roboto_Slab'] text-blue-950 mb-4">Recommended Resources</h3>
                <div id="resources-content" class="resources-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
            </div>

            <div id="ai-tutor-section" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <h3 class="text-2xl font-bold font-['Roboto_Slab'] text-blue-950 mb-4">AI Tutor Assistant</h3>
                <div class="flex flex-col gap-4">
                    <div>
                        <label for="api-key-input" class="block text-sm font-medium text-gray-700">Enter Your Gemini API Key:</label>
                        <div class="mt-1 flex gap-2">
                            <input type="text" id="api-key-input" placeholder="Your API Key" class="flex-1 p-3 border border-gray-300 rounded-lg">
                            <button id="save-api-key-btn" class="btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Save</button>
                        </div>
                    </div>
                    <div id="ai-chat-container" class="border border-gray-300 rounded-lg flex flex-col h-[400px]">
                        <div id="ai-chat-display" class="flex-1 p-4 overflow-y-auto flex flex-col gap-2">
                            <p class="text-center text-gray-500 mt-5">Hello! How can I help you today? Please enter your API key to begin.</p>
                        </div>
                        <form id="ai-input-form" class="p-4 border-t border-gray-300 bg-gray-100 flex gap-2 hidden">
                            <input type="text" id="ai-message-input" placeholder="Ask a question..." class="flex-1 p-3 border border-gray-300 rounded-full">
                            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center transition-colors"><i class="fas fa-paper-plane"></i></button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="student-management" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <h3 class="text-2xl font-bold font-['Roboto_Slab'] text-blue-950 mb-4">Student Management</h3>
                <div id="students-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
                <div id="student-dashboard" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                    <h3 class="text-2xl font-bold font-['Roboto_Slab'] text-blue-950 mb-4">Student Dashboard</h3>
                    <div id="student-content">

                        <!-- My Tutors -->
                        <h4 class="text-xl font-bold text-blue-950 mb-4">My Tutors</h4>
                        <div id="student-tutors" class="flex flex-col gap-3"></div>

                        <!-- My Sessions -->
                        <h4 class="text-xl font-bold text-blue-950 mt-8 mb-4">My Sessions</h4>
                        <div id="student-sessions" class="flex flex-col gap-3"></div>

                        <!-- Group Sessions -->
                        <h4 class="text-xl font-bold text-blue-950 mt-8 mb-4">Available Group Sessions</h4>
                        <div id="student-group-sessions" class="flex flex-col gap-3"></div>

                        <!-- Resources -->
                        <h4 class="text-xl font-bold text-blue-950 mt-8 mb-4">Learning Resources</h4>
                        <div id="student-resources" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

                        <!-- Reviews -->
                        <h4 class="text-xl font-bold text-blue-950 mt-8 mb-4">Rate My Tutor</h4>
                        <form id="student-review-form" class="flex flex-col gap-4">
                            <select id="review-tutor" class="p-3 border rounded-lg">
                                <option value="">Select Tutor</option>
                            </select>
                            <select id="review-rating" class="p-3 border rounded-lg">
                                <option value="5">⭐⭐⭐⭐⭐</option>
                                <option value="4">⭐⭐⭐⭐</option>
                                <option value="3">⭐⭐⭐</option>
                                <option value="2">⭐⭐</option>
                                <option value="1">⭐</option>
                            </select>
                            <textarea id="review-comment" class="p-3 border rounded-lg" placeholder="Write a comment..."></textarea>
                            <button type="submit" class="btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">Submit Review</button>
                        </form>

                    </div>
                </div>

            </div>
        </div>

        <div id="reviews" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-6 hidden">
            <h3 class="text-2xl font-bold font-['Roboto_Slab'] text-blue-950 mb-4">Your Reviews</h3>
            <div id="reviews-content">
                <div id="reviews-given" class="mb-8">
                    <h4 class="text-xl font-bold font-['Roboto_Slab'] text-blue-950 mb-2">Reviews You've Left</h4>
                    <div id="reviews-given-list" class="flex flex-col gap-4">
                        <p class="text-gray-500">You haven't left any reviews yet.</p>
                    </div>
                </div>
                <div id="reviews-received">
                    <h4 class="text-xl font-bold font-['Roboto_Slab'] text-blue-950 mb-2">Reviews for You</h4>
                    <div id="reviews-received-list" class="flex flex-col gap-4">
                        <p class="text-gray-500">No one has reviewed you yet.</p>
                    </div>
                </div>
                <div id="reviews-for-admin" class="hidden">
                    <h4 class="text-xl font-bold font-['Roboto_Slab'] text-blue-950 mb-2">All Reviews (Admin View)</h4>
                    <div id="all-reviews-list" class="flex flex-col gap-4">
                        <p class="text-gray-500">No reviews found.</p>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Custom Alert Modal -->
        <div id="alert-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-[3000]">
            <div class="bg-white rounded-2xl shadow-2xl p-6 text-center w-full max-w-sm relative">
                <p id="alert-modal-message" class="mb-6 text-lg text-gray-800"></p>
                <button id="alert-modal-close" class="btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">OK</button>
            </div>
        </div>

        <!-- Review Modal -->
        <div id="review-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-[4000]">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md relative">
                <span class="close-modal absolute top-4 right-6 text-3xl text-gray-500 cursor-pointer">&times;</span>
                <h3 class="text-2xl font-bold font-['Roboto_Slab'] text-blue-950 mb-4">Leave a Review</h3>
                <p id="review-modal-user" class="text-gray-600 mb-4"></p>
                <form id="review-form">
                    <div class="mb-4">
                        <label class="block mb-2 font-bold text-blue-950">Rating:</label>
                        <div class="flex gap-1 text-yellow-400 text-2xl">
                            <i class="far fa-star cursor-pointer" data-rating="1"></i>
                            <i class="far fa-star cursor-pointer" data-rating="2"></i>
                            <i class="far fa-star cursor-pointer" data-rating="3"></i>
                            <i class="far fa-star cursor-pointer" data-rating="4"></i>
                            <i class="far fa-star cursor-pointer" data-rating="5"></i>
                        </div>
                        <input type="hidden" id="review-rating" name="rating" required>
                    </div>
                    <div class="mb-6">
                        <label for="review-comment" class="block mb-2 font-bold text-blue-950">Comments:</label>
                        <textarea id="review-comment" name="comment" rows="4" required class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                    </div>
                    <button type="submit" class="w-full btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg">Submit Review</button>
                </form>
            </div>
        </div>

        <!-- Document Viewer Modal -->
        <div id="docs-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-[5000]">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg relative">
                <span class="close-modal absolute top-4 right-6 text-3xl text-gray-500 cursor-pointer">&times;</span>
                <h3 class="text-2xl font-bold font-['Roboto_Slab'] text-blue-950 mb-4">Submitted Documents</h3>
                <p id="docs-modal-user" class="text-gray-600 mb-4"></p>
                <div id="docs-list" class="flex flex-col gap-3">
                    <!-- Document links will be injected here -->
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-blue-950 text-white p-6 text-center shadow-md">
        <div class="container mx-auto">
            <p>&copy; <span id="current-year"></span> Dube STEM Mastery. All Rights Reserved.</p>
        </div>
    </footer>

    <script>
        // ======================== LOCAL STORAGE SETUP ========================
        let db = {
            users: {},
            tutorStudents: {},
            chats: {},
            groupChats: {},
            unreadCounts: {},
            reviews: [],
            announcements: [],
            aiTutorConversations: {},
            apiKey: '',
            agoraKey: '',
            sessions: [],
            groupSessions: [],
            resources: {
                'Maths': [
                    { title: 'Calculus Fundamentals', desc: 'A comprehensive guide to understanding basic calculus concepts.', link: 'https://www.dummies.com/article/academics-hobbies/study-guides/math/calculus/calculus-for-dummies-cheat-sheet-209749', icon: 'fas fa-book' },
                    { title: 'Algebra Practice Problems', desc: 'A collection of exercises to sharpen your algebra skills.', link: 'https://www.math-drills.com/', icon: 'fas fa-pencil-ruler' }
                ],
                'Physics': [
                    { title: 'Physics Problem Solving', desc: 'A video series on approaching complex physics problems.', link: 'https://www.youtube.com/watch?v=RlOXnhTujDQ', icon: 'fas fa-video' },
                    { title: 'Newtonian Mechanics Guide', desc: 'An in-depth look at the principles of motion and forces.', link: 'https://www.britannica.com/science/Newtonian-mechanics', icon: 'fas fa-atom' }
                ],
                'IT': [
                    { title: 'Introduction to Python', desc: 'A beginner-friendly guide to learning the Python programming language.', link: 'https://www.w3schools.com/python/', icon: 'fas fa-code' },
                    { title: 'Web Development Basics', desc: 'Resources for getting started with HTML, CSS, and JavaScript.', link: 'https://developer.mozilla.org/en-US/docs/Learn', icon: 'fas fa-globe' }
                ],
                'EGD': [
                    { title: 'EGD Drawing Fundamentals', desc: 'Tutorials and guides for the basics of Engineering Graphics and Design.', link: 'https://www.youtube.com/c/EGDTeacher', icon: 'fas fa-drafting-compass' },
                    { title: '3D CAD Modeling', desc: 'An introduction to using CAD software for 3D design.', link: 'https://www.autodesk.com/solutions/cad-software', icon: 'fas fa-cube' }
                ],
                'General': [
                    { title: 'Past Exam Papers', desc: 'Collection of past papers with detailed solutions.', link: 'https://www.education.gov.za/Curriculum/NationalSeniorCertificate(NSC)Examinations/NSCPastExaminationpapers.aspx', icon: 'fas fa-file-pdf' }
                ]
            }
        };
        const DB_KEY = 'tutoringHubDB';
        const CURRENT_USER_KEY = 'currentUser';

        function saveState() {
            try {
                localStorage.setItem(DB_KEY, JSON.stringify(db));
            } catch (e) {
                console.error("Error saving to local storage:", e);
            }
        }

        function loadState() {
            try {
                const data = localStorage.getItem(DB_KEY);
                if (data) {
                    db = JSON.parse(data);
                } else {
                    // Initial seeded data if no data exists
                    db = {
                        users: {
                            'alice@tutor.com': { uid: 'alice@tutor.com', name: 'Alice Johnson', email: 'alice@tutor.com', role: 'tutor', modules: ['Maths', 'Physics'], level: 'Both', avatar: 'A', bio: 'Passionate about making calculus understandable.', status: 'approved', documents: [] },
                            'bob@tutor.com': { uid: 'bob@tutor.com', name: 'Bob Williams', email: 'bob@tutor.com', role: 'tutor', modules: ['Maths', 'EGD'], level: 'Varsity level', avatar: 'B', bio: 'Expert in linear algebra and advanced functions.', status: 'approved', documents: [] },
                            'charlie@tutor.com': { uid: 'charlie@tutor.com', name: 'Charlie Brown', email: 'charlie@tutor.com', role: 'tutor', modules: ['Physics', 'IT'], level: 'High school level', avatar: 'C', bio: 'Specializing in mechanics and electromagnetism.', status: 'approved', documents: [] },
                            'pending.tutor@test.com': { uid: 'pending.tutor@test.com', name: 'Penelope Pending', email: 'pending.tutor@test.com', role: 'tutor', modules: ['Maths'], level: 'High school level', avatar: 'P', bio: 'Eager to start teaching.', status: 'pending', documents: ['transcript.pdf', 'qualifications.pdf'] },
                            'student1@test.com': { uid: 'student1@test.com', name: 'Sarah Johnson', email: 'student1@test.com', role: 'student', modules: ['Maths', 'IT'], level: 'Grade 11', avatar: 'S', status: 'approved', documents: [] },
                            'student2@test.com': { uid: 'student2@test.com', name: 'John Smith', email: 'student2@test.com', role: 'student', modules: ['Physics'], level: 'Grade 10', avatar: 'J', status: 'approved', documents: [] },
                            'student3@test.com': { uid: 'student3@test.com', name: 'Mary Williams', email: 'student3@test.com', role: 'student', modules: ['Maths'], level: 'Grade 12', avatar: 'M', status: 'approved', documents: [] },
                            'pending.student@test.com': { uid: 'pending.student@test.com', name: 'Sam Pending', email: 'pending.student@test.com', role: 'student', modules: ['EGD'], level: 'Grade 9', avatar: 'S', status: 'pending', documents: ['results.pdf'] },
                            'mrdube@system.com': { uid: 'mrdube@system.com', name: 'Mr. Dube', email: 'mrdube@system.com', role: 'admin', avatar: 'D', status: 'approved' }
                        },
                        tutorStudents: {
                            'alice@tutor.com': ['student1@test.com', 'student3@test.com']
                        },
                        chats: {},
                        groupChats: {
                            'tutor-alice@tutor.com-group': [
                                { senderId: 'alice@tutor.com', text: 'Welcome to the group chat for my students!', createdAt: new Date().toISOString() }
                            ]
                        },
                        unreadCounts: {},
                        reviews: [],
                        aiTutorConversations: {},
                        apiKey: '',
                        agoraKey: '',
                        sessions: [
                            { id: 'sess1', studentId: 'student1@test.com', tutorId: 'alice@tutor.com', date: '2025-09-08T10:00', topic: "Calculus Review", notes: 'Reviewing derivatives.' },
                            { id: 'sess2', studentId: 'student3@test.com', tutorId: 'alice@tutor.com', date: '2025-09-09T14:30', topic: "Linear Algebra", notes: '' },
                            { id: 'sess3', studentId: 'student2@test.com', tutorId: 'charlie@tutor.com', date: '2025-09-10T11:00', topic: "Physics Exam Prep", notes: 'Focus on Newtonian mechanics.' }
                        ],
                        groupSessions: [
                            { id: 'group1', tutorId: 'bob@tutor.com', module: 'Maths', topic: 'Linear Algebra Refresher', date: '2025-09-12T15:00', participants: ['student1@test.com'], maxParticipants: 5, requests: [], chat: [] },
                            { id: 'group2', tutorId: 'charlie@tutor.com', module: 'Physics', topic: 'Electromagnetism Explained', date: '2025-09-13T10:00', participants: [], maxParticipants: 3, requests: ['student2@test.com'], chat: [] }
                        ],
                        moduleRequests: [],
                        resources: {
                            'Maths': [
                                { title: 'Calculus Fundamentals', desc: 'A comprehensive guide to understanding basic calculus concepts.', link: 'https://www.dummies.com/article/academics-hobbies/study-guides/math/calculus/calculus-for-dummies-cheat-sheet-209749', icon: 'fas fa-book' },
                                { title: 'Algebra Practice Problems', desc: 'A collection of exercises to sharpen your algebra skills.', link: 'https://www.math-drills.com/', icon: 'fas fa-pencil-ruler' }
                            ],
                            'Physics': [
                                { title: 'Physics Problem Solving', desc: 'A video series on approaching complex physics problems.', link: 'https://www.youtube.com/watch?v=RlOXnhTujDQ', icon: 'fas fa-video' },
                                { title: 'Newtonian Mechanics Guide', desc: 'An in-depth look at the principles of motion and forces.', link: 'https://www.britannica.com/science/Newtonian-mechanics', icon: 'fas fa-atom' }
                            ],
                            'IT': [
                                { title: 'Introduction to Python', desc: 'A beginner-friendly guide to learning the Python programming language.', link: 'https://www.w3schools.com/python/', icon: 'fas fa-code' },
                                { title: 'Web Development Basics', desc: 'Resources for getting started with HTML, CSS, and JavaScript.', link: 'https://developer.mozilla.org/en-US/docs/Learn', icon: 'fas fa-globe' }
                            ],
                            'EGD': [
                                { title: 'EGD Drawing Fundamentals', desc: 'Tutorials and guides for the basics of Engineering Graphics and Design.', link: 'https://www.youtube.com/c/EGDTeacher', icon: 'fas fa-drafting-compass' },
                                { title: '3D CAD Modeling', desc: 'An introduction to using CAD software for 3D design.', link: 'https://www.autodesk.com/solutions/cad-software', icon: 'fas fa-cube' }
                            ],
                            'General': [
                                { title: 'Past Exam Papers', desc: 'Collection of past papers with detailed solutions.', link: 'https://www.education.gov.za/Curriculum/NationalSeniorCertificate(NSC)Examinations/NSCPastExaminationpapers.aspx', icon: 'fas fa-file-pdf' }
                            ]
                        }
                    };
                    saveState();
                }
            } catch (e) {
                console.error("Error loading from local storage:", e);
                // Fallback to initial data if load fails
                db = {
                    users: {
                        'alice@tutor.com': { uid: 'alice@tutor.com', name: 'Alice Johnson', email: 'alice@tutor.com', role: 'tutor', modules: ['Maths', 'Physics'], level: 'Both', avatar: 'A', bio: 'Passionate about making calculus understandable.', status: 'approved', documents: [] },
                        'bob@tutor.com': { uid: 'bob@tutor.com', name: 'Bob Williams', email: 'bob@tutor.com', role: 'tutor', modules: ['Maths', 'EGD'], level: 'Varsity level', avatar: 'B', bio: 'Expert in linear algebra and advanced functions.', status: 'approved', documents: [] },
                        'charlie@tutor.com': { uid: 'charlie@tutor.com', name: 'Charlie Brown', email: 'charlie@tutor.com', role: 'tutor', modules: ['Physics', 'IT'], level: 'High school level', avatar: 'C', bio: 'Specializing in mechanics and electromagnetism.', status: 'approved', documents: [] },
                        'pending.tutor@test.com': { uid: 'pending.tutor@test.com', name: 'Penelope Pending', email: 'pending.tutor@test.com', role: 'tutor', modules: ['Maths'], level: 'High school level', avatar: 'P', bio: 'Eager to start teaching.', status: 'pending', documents: ['transcript.pdf', 'qualifications.pdf'] },
                        'student1@test.com': { uid: 'student1@test.com', name: 'Sarah Johnson', email: 'student1@test.com', role: 'student', modules: ['Maths', 'IT'], level: 'Grade 11', avatar: 'S', status: 'approved', documents: [], progressNotes: 'Making great progress in calculus.' },
                        'student2@test.com': { uid: 'student2@test.com', name: 'John Smith', email: 'student2@test.com', role: 'student', modules: ['Physics'], level: 'Grade 10', avatar: 'J', status: 'approved', documents: [], progressNotes: 'Needs to review Newtonian mechanics.' }, 'student3@test.com': { uid: 'student3@test.com', name: 'Mary Williams', email: 'student3@test.com', role: 'student', modules: ['Maths'], level: 'Grade 12', avatar: 'M', status: 'approved', documents: [] },
                        'pending.student@test.com': { uid: 'pending.student@test.com', name: 'Sam Pending', email: 'pending.student@test.com', role: 'student', modules: ['EGD'], level: 'Grade 9', avatar: 'S', status: 'pending', documents: ['results.pdf'] },
                        'mrdube@system.com': { uid: 'mrdube@system.com', name: 'Mr. Dube', email: 'mrdube@system.com', role: 'admin', avatar: 'D', status: 'approved' }
                    },
                    tutorStudents: {
                        'alice@tutor.com': ['student1@test.com', 'student3@test.com']
                    },
                    chats: {},
                    groupChats: {},
                    unreadCounts: {},
                    reviews: [],
                    aiTutorConversations: {},
                    apiKey: '',
                    agoraKey: '',
                    sessions: [
                        { id: 'sess1', studentId: 'student1@test.com', tutorId: 'alice@tutor.com', date: '2025-09-08T10:00', notes: 'Calculus review' },
                        { id: 'sess2', studentId: 'student3@test.com', tutorId: 'alice@tutor.com', date: '2025-09-09T14:30', notes: 'Linear Algebra' },
                        { id: 'sess3', studentId: 'student2@test.com', tutorId: 'charlie@tutor.com', date: '2025-09-10T11:00', notes: 'Physics exam prep' }
                    ],
                    groupSessions: [
                        { id: 'group1', tutorId: 'bob@tutor.com', module: 'Maths', topic: 'Linear Algebra Refresher', date: '2025-09-12T15:00', participants: ['student1@test.com'], maxParticipants: 5 },
                        { id: 'group2', tutorId: 'charlie@tutor.com', module: 'Physics', topic: 'Electromagnetism Explained', date: '2025-09-13T10:00', participants: [], maxParticipants: 3 }
                    ],
                    moduleRequests: [],
                    resources: {
                        'Maths': [
                            { title: 'Calculus Fundamentals', desc: 'A comprehensive guide to understanding basic calculus concepts.', link: 'https://www.dummies.com/article/academics-hobbies/study-guides/math/calculus/calculus-for-dummies-cheat-sheet-209749', icon: 'fas fa-book' },
                            { title: 'Algebra Practice Problems', desc: 'A collection of exercises to sharpen your algebra skills.', link: 'https://www.math-drills.com/', icon: 'fas fa-pencil-ruler' }
                        ],
                        'Physics': [
                            { title: 'Physics Problem Solving', desc: 'A video series on approaching complex physics problems.', link: 'https://www.youtube.com/watch?v=RlOXnhTujDQ', icon: 'fas fa-video' },
                            { title: 'Newtonian Mechanics Guide', desc: 'An in-depth look at the principles of motion and forces.', link: 'https://www.britannica.com/science/Newtonian-mechanics', icon: 'fas fa-atom' }
                        ],
                        'IT': [
                            { title: 'Introduction to Python', desc: 'A beginner-friendly guide to learning the Python programming language.', link: 'https://www.w3schools.com/python/', icon: 'fas fa-code' },
                            { title: 'Web Development Basics', desc: 'Resources for getting started with HTML, CSS, and JavaScript.', link: 'https://developer.mozilla.org/en-US/docs/Learn', icon: 'fas fa-globe' }
                        ],
                        'EGD': [
                            { title: 'EGD Drawing Fundamentals', desc: 'Tutorials and guides for the basics of Engineering Graphics and Design.', link: 'https://www.youtube.com/c/EGDTeacher', icon: 'fas fa-drafting-compass' },
                            { title: '3D CAD Modeling', desc: 'An introduction to using CAD software for 3D design.', link: 'https://www.autodesk.com/solutions/cad-software', icon: 'fas fa-cube' }
                        ],
                        'General': [
                            { title: 'Past Exam Papers', desc: 'Collection of past papers with detailed solutions.', link: 'https://www.education.gov.za/Curriculum/NationalSeniorCertificate(NSC)Examinations/NSCPastExaminationpapers.aspx', icon: 'fas fa-file-pdf' }
                        ]
                    }
                };
            }
        }

        // ======================== GLOBAL VARIABLES & DOM ELEMENTS ========================
        let currentUser = null;
        let currentChatPartner = null;
        let currentSessionContext = null;

        const modulesList = ['Maths', 'Physics', 'IT', 'EGD'];
        const mainContentSections = document.querySelectorAll('main > section, footer, header');
        const dashboard = document.getElementById('dashboard');
        const loginLink = document.getElementById('login-link');
        const logoutBtn = document.getElementById('logout-btn');
        const authModal = document.getElementById('auth-modal');
        const navLinks = document.querySelectorAll('.nav-link');
        const dashboardSections = document.querySelectorAll('.dashboard-section');
        const userNameEl = document.getElementById('user-name');
        const userAvatarEl = document.getElementById('user-avatar');
        const userIdEl = document.getElementById('user-id');
        const studentManagementLink = document.getElementById('student-management-link');
        const adminManagementLink = document.getElementById('admin-management-link');
        const aiTutorLink = document.getElementById('ai-tutor-link');
        const chatContactsContainer = document.getElementById('chat-contacts-container');
        const groupChatContactsContainer = document.getElementById('group-chat-contacts-container');
        const chatInputForm = document.getElementById('chat-input-form');
        const chatDisplay = document.getElementById('chat-display');
        const chatHeader = document.getElementById('chat-header');
        const alertModal = document.getElementById('alert-modal');
        const alertModalMessage = document.getElementById('alert-modal-message');
        const signupRoleSelect = document.getElementById('user-role');
        const roleSpecificSignupSection = document.getElementById('role-specific-signup');
        const reviewModal = document.getElementById('review-modal');
        const reviewForm = document.getElementById('review-form');
        const reviewModalUser = document.getElementById('review-modal-user');
        const reviewStars = document.querySelectorAll('#review-form .fa-star');
        const reviewRatingInput = document.getElementById('review-rating');
        const scheduleForm = document.getElementById('schedule-form');
        const scheduleCalendar = document.getElementById('calendar');
        const startVideoCallBtn = document.getElementById('start-video-call-btn');
        const scheduleTutorName = document.getElementById('schedule-tutor-name');
        const groupSessionList = document.getElementById('group-session-list');
        const studentSelect = document.getElementById('student-select');
        const tutorSelect = document.getElementById('tutor-select');
        const agoraKeyInput = document.getElementById('agora-key-input');
        const saveAgoraKeyBtn = document.getElementById('save-agora-key-btn');
        const dmTab = document.getElementById('dm-tab');
        const groupTab = document.getElementById('group-tab');

        // ======================== UTILITY FUNCTIONS ========================
        function showAlert(message) {
            alertModalMessage.textContent = message;
            alertModal.classList.add('flex');
        }

        document.getElementById('alert-modal-close').addEventListener('click', () => {
            alertModal.classList.remove('flex');
        });

        function getFilenameFromPath(filePath) {
            const parts = filePath.split('\\'); // For Windows paths
            return parts[parts.length - 1].split('/').pop(); // For Unix-like paths
        }

        function getStarRatingHTML(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += `<i class="fas fa-star text-yellow-400"></i>`;
                } else {
                    stars += `<i class="far fa-star text-yellow-400"></i>`;
                }
            }
            return stars;
        }

        // ======================== AUTHENTICATION & UI MANAGEMENT ========================
        async function setupUIForLogin() {
            mainContentSections.forEach(el => el.classList.add('hidden'));
            dashboard.classList.remove('hidden');
            loginLink.classList.add('hidden');

            userNameEl.textContent = currentUser.name;
            userAvatarEl.textContent = currentUser.avatar;
            userIdEl.textContent = `User ID: ${currentUser.uid}`;

            // Hide all dashboard nav links by default
            document.querySelectorAll('.dashboard-nav li').forEach(li => li.classList.add('hidden'));

            // Show role-specific links
            document.querySelector('a[href="#dashboard-home"]').parentElement.classList.remove('hidden');
            document.querySelector('a[href="#chat-section"]').parentElement.classList.remove('hidden');
            document.querySelector('a[href="#video-call"]').parentElement.classList.remove('hidden');
            document.querySelector('a[href="#resources"]').parentElement.classList.remove('hidden');
            document.querySelector('a[href="#schedule"]').parentElement.classList.remove('hidden');
            document.querySelector('a[href="#reviews"]').parentElement.classList.remove('hidden');
            aiTutorLink.classList.remove('hidden');

            if (currentUser.role === 'admin') {
                adminManagementLink.classList.remove('hidden');
                // Don't show student management for admin
                studentManagementLink.classList.add('hidden');
                document.getElementById('reviews-for-admin').classList.remove('hidden');
                document.getElementById('reviews-given').classList.add('hidden');
                document.getElementById('reviews-received').classList.add('hidden');
            } else if (currentUser.role === 'tutor') {
                studentManagementLink.classList.remove('hidden');
                adminManagementLink.classList.add('hidden');
                document.getElementById('reviews-for-admin').classList.add('hidden');
                document.getElementById('reviews-given').classList.remove('hidden');
                document.getElementById('reviews-received').classList.remove('hidden');
            } else if (currentUser.role === 'student') {
                adminManagementLink.classList.add('hidden');
                studentManagementLink.classList.add('hidden');
                document.getElementById('reviews-for-admin').classList.add('hidden');
                document.getElementById('reviews-given').classList.remove('hidden');
                document.getElementById('reviews-received').classList.remove('hidden');
            }

            // Show default dashboard section
            dashboardSections.forEach(s => s.classList.add('hidden'));
            navLinks.forEach(l => l.classList.remove('active'));

            // For ALL roles, show the general dashboard home by default
            document.getElementById('dashboard-home').classList.remove('hidden');
            document.querySelector('a[href="#dashboard-home"]').classList.add('active');

            renderDashboardContent();
            renderChatContacts();
            renderMessages();
            renderReviews();
            renderSchedule();
            renderResources();
            renderSeededUserLogins();
            renderVideoCallPage();

        }

        async function setupUIForLogout() {
            localStorage.removeItem(CURRENT_USER_KEY);
            mainContentSections.forEach(el => el.classList.remove('hidden'));
            dashboard.classList.add('hidden');
            loginLink.classList.remove('hidden');
            currentUser = null;
            currentChatPartner = null;
            currentSessionContext = null;
            renderTutors();
            chatHeader.querySelector('span').textContent = "Select a contact";
            document.getElementById('chat-header-buttons').innerHTML = '';

            chatDisplay.innerHTML = `<p class="text-center text-gray-500 mt-5">Select a contact to start chatting.</p>`;
            chatInputForm.classList.add('hidden');
            // Clear AI chat state
            document.getElementById('ai-chat-display').innerHTML = `<p class="text-center text-gray-500 mt-5">Hello! How can I help you today? Please enter your API key to begin.</p>`;
            document.getElementById('ai-input-form').classList.add('hidden');
        }

        // Simulates a login by checking a user's existence and status
        function handleLogin(email) {
            const user = db.users[email.toLowerCase()];
            if (!user) {
                showAlert('User not found. Please check your email or sign up.');
                return;
            }
            if (user.status === 'pending') {
                showAlert('Your account is pending administrator approval.');
                return;
            }
            currentUser = user;
            localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));
            setupUIForLogin();
            authModal.classList.remove('flex');
        }

        // Simulates a new user creation with a pending status
        function handleSignup(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('#signup-name').value;
            const email = form.querySelector('#signup-email').value;
            const role = form.querySelector('#user-role').value;
            const documents = [];
            const modules = [];

            if (!role) {
                showAlert("Please select a role (Student or Tutor).");
                return;
            }

            const lowerEmail = email.toLowerCase();
            if (db.users[lowerEmail]) {
                showAlert('An account with this email already exists.');
                return;
            }

            // Get selected modules
            const moduleCheckboxes = roleSpecificSignupSection.querySelectorAll('input[name="modules"]:checked');
            if (moduleCheckboxes.length === 0) {
                showAlert('Please select at least one module.');
                return;
            }
            moduleCheckboxes.forEach(cb => modules.push(cb.value));

            // Get uploaded documents
            const fileInputs = roleSpecificSignupSection.querySelectorAll('input[type="file"]');
            let hasFiles = false;
            fileInputs.forEach(input => {
                if (input.files.length > 0) {
                    hasFiles = true;
                    for (const file of input.files) {
                        documents.push(file.name);
                    }
                }
            });

            if (role === 'tutor' && !hasFiles) {
                showAlert("Please upload the required documents.");
                return;
            }

            const level = role === 'tutor' ? form.querySelector('#tutor-level').value : form.querySelector('#student-level').value;
            if (!level) {
                showAlert("Please select a level.");
                return;
            }


            db.users[lowerEmail] = {
                uid: lowerEmail,
                name,
                email: lowerEmail,
                role,
                modules,
                level: level,
                avatar: name.charAt(0).toUpperCase(),
                status: 'pending',
                documents: documents,
                tutorStudents: []
            };
            saveState();
            showAlert('Sign up successful! Your account is now pending administrator approval. An admin will review your uploaded documents.');
            form.reset();
            document.querySelector('.auth-tab[data-tab="login"]').click();
        }

        // ======================== LOCAL STORAGE DATA MANAGEMENT ========================

        function renderDashboardContent() {
            const dashboardContent = document.getElementById('dashboard-content');
            dashboardContent.innerHTML = '';

            if (currentUser.role === 'admin') {
                const pendingUsers = Object.values(db.users).filter(u => u.status === 'pending');
                const totalUsers = Object.keys(db.users).length;
                const approvedTutors = Object.values(db.users).filter(u => u.role === 'tutor' && u.status === 'approved').length;
                dashboardContent.innerHTML = `
                <h4 class="font-['Roboto_Slab'] text-blue-950 text-xl font-bold">System Overview</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    <div class="bg-blue-100 p-4 rounded-lg shadow"><p class="text-3xl font-bold">${totalUsers}</p><p class="text-gray-700">Total Users</p></div>
                    <div class="bg-green-100 p-4 rounded-lg shadow"><p class="text-3xl font-bold">${approvedTutors}</p><p class="text-gray-700">Approved Tutors</p></div>
                    <div class="bg-red-100 p-4 rounded-lg shadow"><p class="text-3xl font-bold">${pendingUsers.length}</p><p class="text-gray-700">Pending Approvals</p></div>
                </div>
                <p class="mt-4 text-gray-700">
                    ${pendingUsers.length > 0 ? `You have users awaiting approval. <a href="#admin-management" class="text-blue-500 font-semibold hover:underline nav-link">Review them now.</a>` : 'No users are currently pending approval.'}
                </p>
            `;

            } else if (currentUser.role === 'tutor') {
                const myStudents = db.tutorStudents[currentUser.uid] || [];
                const myUpcomingSessions = db.sessions.filter(s => s.tutorId === currentUser.uid && new Date(s.date) > new Date());
                const latestAnnouncement = db.announcements && db.announcements.length > 0 ? db.announcements[db.announcements.length - 1] : "No new announcements.";

                dashboardContent.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 flex flex-col gap-6">
                        <div>
                            <h4 class="font-['Roboto_Slab'] text-blue-950 text-xl font-bold mb-4">🗓️ Your Next Sessions</h4>
                            <div id="tutor-upcoming-sessions" class="flex flex-col gap-3"></div>
                        </div>
                        <div>
                            <h4 class="font-['Roboto_Slab'] text-blue-950 text-xl font-bold mb-4">📢 Latest Announcement</h4>
                            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-r-lg">
                                <p>${latestAnnouncement}</p>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-1 flex flex-col gap-6">
                        <div>
                            <h4 class="font-['Roboto_Slab'] text-blue-950 text-xl font-bold mb-4">🚀 Quick Actions</h4>
                            <div class="flex flex-col gap-2">
                                <button class="btn bg-purple-500 hover:bg-purple-600 text-white text-center" id="manage-modules-btn">Manage Modules</button>
                                <a href="#schedule" class="nav-link btn bg-green-500 hover:bg-green-600 text-white text-center">Schedule Group Session</a>
                                <a href="#resources" class="nav-link btn bg-blue-500 hover:bg-blue-600 text-white text-center">Manage Resources</a>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-['Roboto_Slab'] text-blue-950 text-xl font-bold mb-4">👥 Student Watchlist (${myStudents.length})</h4>
                            <div id="tutor-student-list" class="flex flex-col gap-2"></div>
                            <a href="#student-management" class="nav-link text-blue-500 hover:underline mt-2 inline-block">Manage All Students →</a>
                        </div>
                    </div>
                </div>
            `;

                const sessionsContainer = document.getElementById('tutor-upcoming-sessions');
                if (myUpcomingSessions.length > 0) {
                    myUpcomingSessions.slice(0, 3).forEach(session => {
                        const student = db.users[session.studentId];
                        const sessionDate = new Date(session.date);
                        sessionsContainer.innerHTML += `
                        <div class="bg-gray-100 p-4 rounded-lg shadow-sm flex items-center justify-between">
                            <div>
                                <p class="font-bold text-gray-800">Session with ${student.name}</p>
                                <p class="text-sm text-gray-600">${sessionDate.toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' })}</p>
                                 <p class="text-sm italic text-gray-500 mt-1">Topic: ${session.topic}</p>
                            </div>
                             <button class="btn join-session-btn bg-blue-500 text-white text-sm py-1 px-3" data-session-id="${session.id}" data-session-type="one-on-one">Start Call</button>
                        </div>
                    `;
                    });
                } else {
                    sessionsContainer.innerHTML = `<p class="text-gray-500 p-4 bg-gray-100 rounded-lg">No upcoming sessions. Time to schedule some!</p>`;
                }

                const studentsContainer = document.getElementById('tutor-student-list');
                if (myStudents.length > 0) {
                    myStudents.slice(0, 4).forEach(studentId => {
                        const student = db.users[studentId];
                        studentsContainer.innerHTML += `
                         <div class="bg-gray-50 p-2 rounded-md flex items-center gap-3">
                             <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-sm">${student.avatar}</div>
                             <span class="font-semibold text-gray-700">${student.name}</span>
                         </div>
                    `;
                    });
                } else {
                    studentsContainer.innerHTML = `<p class="text-gray-500">No students assigned yet.</p>`;
                }

            } else if (currentUser.role === 'student') {
                renderStudentDashboard();
            }
        }
        function renderTutors() {
            const tutorGrid = document.getElementById('tutor-grid');
            tutorGrid.innerHTML = '';

            const approvedTutors = Object.values(db.users).filter(u => u.role === 'tutor' && u.status === 'approved');

            if (approvedTutors.length === 0) {
                tutorGrid.innerHTML = '<p class="text-center text-gray-500">No approved tutors are available at the moment. Please check back later.</p>';
            } else {
                approvedTutors.forEach(tutor => {
                    // Calculate average rating
                    const tutorReviews = db.reviews.filter(r => r.reviewedId === tutor.uid);
                    const totalRating = tutorReviews.reduce((sum, r) => sum + r.rating, 0);
                    const avgRating = tutorReviews.length > 0 ? (totalRating / tutorReviews.length).toFixed(1) : 'N/A';
                    const reviewCount = tutorReviews.length;

                    const card = `
                                    <div class="tutor-card bg-white rounded-lg shadow-md p-6 text-center transition-all duration-300 hover:scale-105">
                                        <div class="w-24 h-24 rounded-full bg-blue-950 text-white flex items-center justify-center text-4xl font-['Roboto_Slab'] mx-auto mb-4">${tutor.avatar}</div>
                                        <h3 class="text-xl font-bold font-['Roboto_Slab'] text-blue-950">${tutor.name}</h3>
                                        <p class="text-blue-500 font-semibold mb-2">${tutor.modules.join(', ')} - ${tutor.level}</p>
                                        <div class="flex items-center justify-center mb-4">
                                            <span class="text-lg font-bold mr-2">${avgRating}</span>
                                            <div class="text-sm">
                                                ${getStarRatingHTML(Math.round(avgRating))}
                                            </div>
                                            <span class="text-gray-500 ml-2">(${reviewCount} reviews)</span>
                                        </div>
                                        <p class="text-gray-700 text-sm mb-4">${tutor.bio}</p>
                                        <button class="btn book-session-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm" data-tutor-id="${tutor.uid}">Book Session</button>
                                    </div>
                                `;
                    tutorGrid.insertAdjacentHTML('beforeend', card);
                });
            }
        }

        function populateTutorSelect(studentId) {
            const tutorSelect = document.getElementById('tutor-select');
            tutorSelect.innerHTML = '<option value="">Select a tutor</option>';

            const allApprovedTutors = Object.values(db.users).filter(u => u.role === 'tutor' && u.status === 'approved');

            if (studentId) {
                const student = db.users[studentId];
                if (student) {
                    const filteredTutors = allApprovedTutors.filter(tutor =>
                        tutor.modules.some(module => student.modules.includes(module))
                    );
                    filteredTutors.forEach(tutor => {
                        const option = document.createElement('option');
                        option.value = tutor.uid;
                        option.textContent = `${tutor.name} (${tutor.modules.join(', ')})`;
                        tutorSelect.appendChild(option);
                    });
                }
            } else {
                allApprovedTutors.forEach(tutor => {
                    const option = document.createElement('option');
                    option.value = tutor.uid;
                    option.textContent = `${tutor.name} (${tutor.modules.join(', ')})`;
                    tutorSelect.appendChild(option);
                });
            }
        }

        function renderAdminManagement() {
            const adminContent = document.getElementById('admin-content');

            // ========== System Analytics ==========
            const totalUsers = Object.keys(db.users).length;
            const activeTutors = Object.values(db.users).filter(u => u.role === 'tutor' && u.status === 'approved').length;
            const sessionsThisWeek = db.sessions.filter(s => {
                const sessionDate = new Date(s.date);
                const now = new Date();
                const weekFromNow = new Date();
                weekFromNow.setDate(now.getDate() + 7);
                return sessionDate >= now && sessionDate <= weekFromNow;
            }).length;

            // Analytics Cards
            let html = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
              <div class="bg-white p-6 rounded-lg shadow">
                <h4 class="text-gray-700 font-bold">Total Users</h4>
                <p class="text-2xl font-semibold text-blue-500">${totalUsers}</p>
              </div>
              <div class="bg-white p-6 rounded-lg shadow">
                <h4 class="text-gray-700 font-bold">Active Tutors</h4>
                <p class="text-2xl font-semibold text-green-500">${activeTutors}</p>
              </div>
              <div class="bg-white p-6 rounded-lg shadow">
                <h4 class="text-gray-700 font-bold">Sessions This Week</h4>
                <p class="text-2xl font-semibold text-purple-500">${sessionsThisWeek}</p>
              </div>
            </div>
        `;

            // ========== User Management ==========
            html += `<h4 class="text-xl font-bold text-blue-950 mb-4">Manage Users</h4>`;
            html += `<div id="admin-user-list" class="flex flex-col gap-4">`;

            Object.values(db.users).forEach(user => {
                const documentsHtml = (user.documents && user.documents.length > 0)
                    ? `<button class="btn view-docs-btn bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-lg text-sm" data-user-id="${user.uid}">View Docs</button>`
                    : '';
                html += `
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center bg-gray-100 p-4 rounded-lg shadow-sm">
                      <div class="mb-2 md:mb-0">
                        <p class="font-bold">${user.name} (${user.email})</p>
                        <p class="text-sm text-gray-600">Role: ${user.role} | Status: ${user.status}</p>
                      </div>
                      <div class="flex flex-wrap gap-2">
                        ${documentsHtml}
                        ${user.status === 'pending' ? `<button class="btn approve-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded" data-user-id="${user.uid}">Approve</button><button class="btn reject-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded" data-user-id="${user.uid}">Reject</button>` : ''}
                        ${user.status === 'approved' ? `<button class="btn suspend-btn bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded" data-user-id="${user.uid}">Suspend</button>` : ''}
                      </div>
                    </div>
                    `;
            });
            html += `</div>`;

            // ========== Module Requests ==========
            html += `<h4 class="text-xl font-bold text-blue-950 mt-8 mb-4">Module Requests</h4>`;
            html += `<div id="admin-module-requests" class="flex flex-col gap-4">`;
            if (db.moduleRequests && db.moduleRequests.length > 0) {
                db.moduleRequests.forEach((req, index) => {
                    const tutor = db.users[req.tutorId];
                    html += `
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center bg-yellow-100 p-4 rounded-lg shadow-sm">
                                <div class="mb-2 md:mb-0">
                                    <p><strong>${tutor.name}</strong> requests to add <strong>${req.module}</strong></p>
                                    <p class="text-sm">Document: <em>${req.document}</em> <button class="text-blue-500 hover:underline text-sm ml-2" onclick="showAlert('This is a simulated view of ${req.document}.')">(View)</button></p>
                                </div>
                                <div class="flex gap-2">
                                   <button class="btn approve-module-btn bg-green-500 text-white px-3 py-1" data-request-index="${index}">Approve</button>
                                   <button class="btn decline-module-btn bg-red-500 text-white px-3 py-1" data-request-index="${index}">Decline</button>
                                </div>
                            </div>
                        `;
                });
            } else {
                html += `<p class="text-gray-500">No pending module requests.</p>`;
            }
            html += `</div>`;


            // ========== Tutor Assignment ==========
            html += `
        <h4 class="text-xl font-bold text-blue-950 mt-8 mb-4">Assign Tutors to Students</h4>
        <div class="bg-gray-100 p-4 rounded-lg">
          <form id="tutor-assignment-form" class="flex flex-col md:flex-row gap-4">
            <select id="student-select" class="p-3 border rounded-lg flex-1">
              <option value="">Select Student</option>
              ${Object.values(db.users).filter(u => u.role === 'student' && u.status === 'approved').map(s => `<option value="${s.uid}">${s.name}</option>`).join('')}
            </select>
            <select id="tutor-select" class="p-3 border rounded-lg flex-1">
              <option value="">Select Tutor</option>
              ${Object.values(db.users).filter(u => u.role === 'tutor' && u.status === 'approved').map(t => `<option value="${t.uid}">${t.name}</option>`).join('')}
            </select>
            <button type="submit" class="btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Assign</button>
          </form>
          <div id="assignment-list" class="mt-4 text-sm text-gray-700">
            ${Object.entries(db.tutorStudents).map(([tutorId, students]) => {
                const tutor = db.users[tutorId];
                return `<p><strong>${tutor.name}</strong> → ${students.map(sid => db.users[sid]?.name).join(', ')}</p>`;
            }).join('')}
          </div>
        </div>`;

            // ========== Sessions ==========
            html += `<h4 class="text-xl font-bold text-blue-950 mt-8 mb-4">Scheduled Sessions</h4>`;
            html += `<div id="admin-sessions" class="flex flex-col gap-3">`;
            db.sessions.forEach(s => {
                const student = db.users[s.studentId];
                const tutor = db.users[s.tutorId];
                html += `
            <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg shadow-sm">
              <span><strong>Student:</strong> ${student?.name} | <strong>Tutor:</strong> ${tutor?.name} | <strong>Date:</strong> ${s.date}</span>
              <div class="flex gap-2">
                <button class="btn cancel-session bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded" data-session-id="${s.id}">Cancel</button>
              </div>
            </div>
            `;
            });
            html += `</div>`;

            // ========== Reviews ==========
            html += `<h4 class="text-xl font-bold text-blue-950 mt-8 mb-4">Review Management</h4>`;
            html += `<div id="admin-reviews" class="flex flex-col gap-3">`;
            db.reviews.forEach((r, i) => {
                const reviewer = db.users[r.reviewerId];
                const reviewed = db.users[r.reviewedId];
                html += `
            <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg shadow-sm">
              <span><strong>${reviewer?.name}</strong> → ${reviewed?.name}: ${r.rating}★ "${r.comment}"</span>
              <button class="btn delete-review bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded" data-review-index="${i}">Delete</button>
            </div>
            `;
            });
            html += `</div>`;

            // ========== Announcements ==========
            html += `
        <h4 class="text-xl font-bold text-blue-950 mt-8 mb-4">Announcements</h4>
        <form id="announcement-form" class="flex flex-col md:flex-row gap-4 mb-4">
          <input type="text" id="announcement-input" placeholder="Write announcement..." class="p-3 border rounded-lg flex-1">
          <button type="submit" class="btn bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg">Post</button>
        </form>
        <div id="announcement-list" class="flex flex-col gap-2 text-sm text-gray-700">
          ${(db.announcements || []).map(a => `<div class="bg-gray-100 p-3 rounded-lg shadow-sm">📢 ${a}</div>`).join('')}
        </div>
        `;

            adminContent.innerHTML = html;

            // ===== Attach Event Listeners =====
            adminContent.querySelectorAll('.approve-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const userId = btn.dataset.userId;
                    db.users[userId].status = 'approved';
                    saveState();
                    renderAdminManagement();
                });
            });

            adminContent.querySelectorAll('.suspend-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const userId = btn.dataset.userId;
                    db.users[userId].status = 'suspended';
                    saveState();
                    renderAdminManagement();
                });
            });

            adminContent.querySelectorAll('.reset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const userId = btn.dataset.userId;
                    alert(`Password reset link sent to ${db.users[userId].email}`);
                });
            });

            adminContent.querySelectorAll('.cancel-session').forEach(btn => {
                btn.addEventListener('click', () => {
                    const sessionId = btn.dataset.sessionId;
                    db.sessions = db.sessions.filter(s => s.id !== sessionId);
                    saveState();
                    renderAdminManagement();
                });
            });

            adminContent.querySelectorAll('.delete-review').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = btn.dataset.reviewIndex;
                    db.reviews.splice(index, 1);
                    saveState();
                    renderAdminManagement();
                });
            });

            const tutorForm = document.getElementById('tutor-assignment-form');
            tutorForm.addEventListener('submit', e => {
                e.preventDefault();
                const studentId = document.getElementById('student-select').value;
                const tutorId = document.getElementById('tutor-select').value;
                if (!studentId || !tutorId) return;
                if (!db.tutorStudents[tutorId]) db.tutorStudents[tutorId] = [];
                if (!db.tutorStudents[tutorId].includes(studentId)) {
                    db.tutorStudents[tutorId].push(studentId);
                }
                saveState();
                renderAdminManagement();
            });

            const annForm = document.getElementById('announcement-form');
            annForm.addEventListener('submit', e => {
                e.preventDefault();
                const text = document.getElementById('announcement-input').value;
                if (!db.announcements) db.announcements = [];
                if (text) {
                    db.announcements.push(text);
                    saveState();
                    renderAdminManagement();
                }
            });
        }



        function renderStudentDashboard() {
            const studentDashboard = document.getElementById('dashboard-content');
            if (!studentDashboard) return;

            // --- DATA FETCHING ---
            const now = new Date();

            const myUpcomingOneOnOne = db.sessions.filter(s => s.studentId === currentUser.uid && new Date(s.date) > now);
            const myUpcomingGroup = db.groupSessions.filter(gs => gs.participants.includes(currentUser.uid) && new Date(gs.date) > now);
            const allMyUpcoming = [...myUpcomingOneOnOne, ...myUpcomingGroup].sort((a, b) => new Date(a.date) - new Date(b.date));
            const nextSession = allMyUpcoming[0];

            const myPastSession = db.sessions
                .filter(s => s.studentId === currentUser.uid && new Date(s.date) < now)
                .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

            const myTutorIds = Object.keys(db.tutorStudents).filter(tutorId => db.tutorStudents[tutorId].includes(currentUser.uid));
            const latestAnnouncement = db.announcements && db.announcements.length > 0 ? db.announcements[db.announcements.length - 1] : "No new announcements.";

            // --- HTML TEMPLATES ---
            let upcomingSessionHtml = `
            <div class="bg-gray-100 p-6 rounded-lg text-center">
                <i class="fas fa-calendar-check text-4xl text-gray-400 mb-3"></i>
                <h5 class="font-bold text-lg text-gray-800">No Upcoming Sessions</h5>
                <p class="text-gray-600">Use the 'Schedule' tab to find a class!</p>
            </div>`;

            if (nextSession) {
                const tutor = db.users[nextSession.tutorId];
                const sessionDate = new Date(nextSession.date);
                const isGroupSession = !!nextSession.participants;

                upcomingSessionHtml = `
                <div class="bg-blue-500 text-white p-6 rounded-lg shadow-xl">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm opacity-80">YOUR NEXT SESSION IS</p>
                            <h5 class="font-bold text-2xl">${sessionDate.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' })}</h5>
                            <p class="font-semibold">${sessionDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} with ${tutor.name}</p>
                            <p class="font-semibold mt-1 text-blue-200">${isGroupSession ? 'Group Session' : 'One-on-One'}: ${nextSession.topic}</p>
                        </div>
                        <i class="fas fa-arrow-right text-2xl opacity-50"></i>
                    </div>
                     <button class="w-full mt-4 btn bg-white text-blue-500 hover:bg-gray-200 font-bold join-session-btn" data-session-id="${nextSession.id}" data-session-type="${isGroupSession ? 'group' : 'one-on-one'}">Join Session</button>
                </div>`;
            }

            let myTutorsHtml = '<p class="text-sm text-gray-500">You are not yet assigned to a tutor.</p>';
            if (myTutorIds.length > 0) {
                myTutorsHtml = myTutorIds.map(tutorId => {
                    const tutor = db.users[tutorId];
                    return `
                    <div class="bg-gray-100 p-3 rounded-lg flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-950 text-white flex items-center justify-center font-bold">${tutor.avatar}</div>
                            <div>
                                <p class="font-semibold text-gray-800">${tutor.name}</p>
                                <p class="text-xs text-gray-500">${tutor.modules.join(', ')}</p>
                            </div>
                        </div>
                        <button class="btn bg-blue-500 text-white text-xs py-1 px-3 message-user-btn" data-user-id="${tutor.uid}">Message</button>
                    </div>`;
                }).join('');
            }

            let reviewPromptHtml = '';
            if (myPastSession) {
                const tutorToReview = db.users[myPastSession.tutorId];
                const alreadyReviewed = db.reviews.some(r => r.reviewerId === currentUser.uid && r.reviewedId === tutorToReview.uid);
                if (!alreadyReviewed) {
                    reviewPromptHtml = `
                    <div>
                        <h4 class="text-xl font-bold mb-3 text-gray-700">⭐ Rate Your Last Session</h4>
                        <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-r-lg flex justify-between items-center">
                            <div>
                                <p class="font-bold">How was your session with ${tutorToReview.name}?</p>
                                <p>Your feedback helps us improve!</p>
                            </div>
                            <button class="btn bg-green-500 text-white font-bold py-1 px-3" onclick="document.querySelector('a[href=\\'#reviews\\']').click()">Rate Now</button>
                        </div>
                    </div>`;
                }
            }

            // --- FINAL ASSEMBLY ---
            studentDashboard.innerHTML = `
            <h3 class="text-3xl font-bold font-['Roboto_Slab'] text-blue-950 mb-6">Welcome back, ${currentUser.name.split(' ')[0]}!</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="flex flex-col gap-6">
                    <div>
                        <h4 class="text-xl font-bold mb-3 text-gray-700">What's Next?</h4>
                        ${upcomingSessionHtml}
                    </div>
                    <div>
                        <h4 class="text-xl font-bold mb-3 text-gray-700">Your Tutors</h4>
                        <div class="flex flex-col gap-3">
                           ${myTutorsHtml}
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-6">
                    ${reviewPromptHtml}
                     <div>
                        <h4 class="font-['Roboto_Slab'] text-blue-950 text-xl font-bold mb-4">🚀 Quick Actions</h4>
                         <button class="btn bg-purple-500 hover:bg-purple-600 text-white text-center w-full" id="manage-modules-btn">Manage Modules</button>
                    </div>
                    <div>
                        <h4 class="text-xl font-bold mb-3 text-gray-700">📢 Announcements</h4>
                         <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-r-lg">
                            <p>${latestAnnouncement}</p>
                        </div>
                    </div>
                </div>
            </div>
        `
        }


        function renderStudentManagement() {
            const studentsGrid = document.getElementById('students-grid');
            studentsGrid.innerHTML = '';

            const studentIds = db.tutorStudents[currentUser.uid] || [];
            const students = studentIds.map(id => db.users[id]).filter(Boolean);

            if (students.length === 0) {
                studentsGrid.innerHTML = `<p class="text-center text-gray-500">You have no students assigned yet.</p>`;
                return;
            }

            const cardsHtml = students.map(student => `
                            <div class="student-card bg-gray-100 p-6 rounded-lg shadow-md text-center">
                                <div class="w-20 h-20 rounded-full bg-blue-500 text-white text-3xl flex items-center justify-center mx-auto mb-4">${student.avatar}</div>
                                <h4 class="font-bold text-blue-950">${student.name}</h4>
                                <p class="text-sm text-gray-600">${student.level} - ${student.modules.join(', ')}</p>
                                <div class="mt-4 flex justify-center gap-2">
                                    <button class="student-btn remove-student-btn bg-red-500 hover:bg-red-600 text-white text-xs py-2 px-4 rounded-md" data-student-id="${student.uid}">Remove</button>
                                    <button class="student-btn message-student-btn bg-blue-500 hover:bg-blue-600 text-white text-xs py-2 px-4 rounded-md" data-student-id="${student.uid}">Message</button>
                                </div>
                            </div>
                        `).join('');
            studentsGrid.innerHTML = cardsHtml;
        }

        function renderSchedule() {
            const tutorSessionView = document.getElementById('tutor-session-view');
            const studentSessionView = document.getElementById('student-session-view');
            const scheduleFormContainer = document.querySelector('.scheduling-form');
            const tutorFields = document.getElementById('tutor-schedule-fields');
            const availableClassesContainer = document.getElementById('available-classes');
            const pendingRequestsContainer = document.getElementById('pending-requests');
            const now = new Date();

            // Reset view
            tutorSessionView.classList.add('hidden');
            studentSessionView.classList.add('hidden');
            scheduleFormContainer.classList.add('hidden');
            availableClassesContainer.classList.add('hidden');
            pendingRequestsContainer.classList.add('hidden');
            tutorFields.classList.add('hidden');

            if (currentUser.role === 'tutor') {
                tutorSessionView.classList.remove('hidden');
                scheduleFormContainer.classList.remove('hidden');
                tutorFields.classList.remove('hidden');
                pendingRequestsContainer.classList.remove('hidden');

                // Populate student dropdown for one-on-one
                const studentSelect = document.getElementById('schedule-student-select');
                const myStudents = db.tutorStudents[currentUser.uid] || [];
                studentSelect.innerHTML = myStudents.map(sid => `<option value="${sid}">${db.users[sid].name}</option>`).join('');

                // Toggle between one-on-one and group fields
                const sessionTypeSelect = document.getElementById('session-type');
                sessionTypeSelect.addEventListener('change', () => {
                    document.getElementById('one-on-one-fields').classList.toggle('hidden', sessionTypeSelect.value !== 'one-on-one');
                    document.getElementById('group-fields').classList.toggle('hidden', sessionTypeSelect.value !== 'group');
                });
                sessionTypeSelect.dispatchEvent(new Event('change')); // Trigger initial state

                // Render tutor's upcoming sessions (1-on-1 and group)
                const tutorUpcomingList = document.getElementById('tutor-upcoming-list');
                const mySessions = db.sessions.filter(s => s.tutorId === currentUser.uid && new Date(s.date) > now);
                const myGroupSessions = db.groupSessions.filter(s => s.tutorId === currentUser.uid && new Date(s.date) > now);
                const allMyUpcomingSessions = [...mySessions, ...myGroupSessions].sort((a, b) => new Date(a.date) - new Date(b.date));

                if (allMyUpcomingSessions.length > 0) {
                    tutorUpcomingList.innerHTML = '<div class="flex flex-col gap-3">' + allMyUpcomingSessions.map(s => {
                        const sessionDate = new Date(s.date).toLocaleString();
                        if (s.studentId) { // One-on-one
                            const student = db.users[s.studentId];
                            return `<div class="bg-white p-4 rounded-lg shadow-sm">
                                            <p class="font-bold text-blue-950">1-on-1 with ${student.name}</p>
                                            <p class="text-sm font-semibold text-gray-800">Topic: ${s.topic || 'N/A'}</p>
                                            <p class="text-sm text-gray-700">${sessionDate}</p>
                                            <div class="mt-2 flex gap-2">
                                                <button class="btn join-session-btn bg-blue-500 text-white text-xs py-1 px-3" data-session-id="${s.id}" data-session-type="one-on-one">Start Call</button>
                                                <button class="btn cancel-session-btn bg-red-500 text-white text-xs py-1 px-3" data-session-id="${s.id}" data-type="one-on-one">Cancel</button>
                                            </div>
                                        </div>`;
                        } else { // Group
                            return `<div class="bg-white p-4 rounded-lg shadow-sm">
                                            <p class="font-bold text-blue-950">Group: ${s.topic}</p>
                                            <p class="text-sm text-gray-700">${sessionDate} (${s.participants.length}/${s.maxParticipants} joined)</p>
                                             <div class="mt-2 flex gap-2">
                                                <button class="btn join-session-btn bg-blue-500 text-white text-xs py-1 px-3" data-session-id="${s.id}" data-session-type="group">Start Call</button>
                                                <button class="btn cancel-session-btn bg-red-500 text-white text-xs py-1 px-3" data-session-id="${s.id}" data-type="group">Cancel</button>
                                            </div>
                                        </div>`;
                        }
                    }).join('') + '</div>';
                } else {
                    tutorUpcomingList.innerHTML = `<p class="text-gray-500 p-4">No upcoming sessions.</p>`
                }

                // Render pending requests for tutor
                const pendingRequestsList = document.getElementById('pending-requests-list');
                const myPendingRequests = db.groupSessions.flatMap(gs =>
                    gs.tutorId === currentUser.uid ?
                        (gs.requests || []).map(studentId => ({ ...gs, studentId }))
                        : []
                );

                if (myPendingRequests.length > 0) {
                    pendingRequestsList.innerHTML = myPendingRequests.map(req => {
                        const student = db.users[req.studentId];
                        return `<div class="bg-yellow-100 p-3 rounded-lg flex justify-between items-center">
                                        <span><strong>${student.name}</strong> wants to join "<strong>${req.topic}</strong>"</span>
                                        <div>
                                            <button class="btn approve-request-btn bg-green-500 text-white text-xs py-1 px-2" data-session-id="${req.id}" data-student-id="${req.studentId}">Approve</button>
                                            <button class="btn decline-request-btn bg-red-500 text-white text-xs py-1 px-2" data-session-id="${req.id}" data-student-id="${req.studentId}">Decline</button>
                                        </div>
                                    </div>`;
                    }).join('');
                } else {
                    pendingRequestsList.innerHTML = `<p class="text-gray-500">No pending requests.</p>`;
                }


            } else if (currentUser.role === 'student') {
                studentSessionView.classList.remove('hidden');
                availableClassesContainer.classList.remove('hidden');

                const upcomingList = document.getElementById('student-upcoming-list');
                const pastList = document.getElementById('student-past-list');

                // Filter sessions
                const myOneOnOne = db.sessions.filter(s => s.studentId === currentUser.uid);
                const myGroup = db.groupSessions.filter(gs => gs.participants.includes(currentUser.uid));
                const allMySessions = [...myOneOnOne, ...myGroup];

                const upcoming = allMySessions.filter(s => new Date(s.date) > now).sort((a, b) => new Date(a.date) - new Date(b.date));
                const past = allMySessions.filter(s => new Date(s.date) <= now).sort((a, b) => new Date(b.date) - new Date(a.date));

                // Render upcoming sessions
                if (upcoming.length > 0) {
                    upcomingList.innerHTML = '<div class="flex flex-col gap-3">' + upcoming.map(s => {
                        const tutor = db.users[s.tutorId];
                        const sessionDate = new Date(s.date).toLocaleString();
                        const isGroup = !!s.participants;
                        return `<div class="bg-gray-200 p-4 rounded-lg shadow-sm">
                                        <p class="font-bold text-blue-950">${isGroup ? 'Group' : '1-on-1'} with ${tutor.name}</p>
                                        <p class="text-sm font-semibold text-gray-800">Topic: ${s.topic || 'N/A'}</p>
                                        <p class="text-sm text-gray-700">${sessionDate}</p>
                                        <div class="mt-2 flex gap-2">
                                            <button class="btn join-session-btn bg-blue-500 text-white text-xs py-1 px-3" data-session-id="${s.id}" data-session-type="${isGroup ? 'group' : 'one-on-one'}">Join Call</button>
                                            ${!isGroup ? `<button class="btn cancel-session-btn bg-red-500 text-white text-xs py-1 px-3" data-session-id="${s.id}" data-type="one-on-one">Cancel</button>` : ''}
                                        </div>
                                    </div>`;
                    }).join('') + '</div>';
                } else {
                    upcomingList.innerHTML = `<p class="text-gray-500 p-4">No upcoming sessions.</p>`;
                }

                // Render past sessions
                if (past.length > 0) {
                    pastList.innerHTML = '<div class="flex flex-col gap-3">' + past.map(s => {
                        const tutor = db.users[s.tutorId];
                        const sessionDate = new Date(s.date).toLocaleString();
                        const isGroup = !!s.participants;
                        return `<div class="bg-gray-200 p-4 rounded-lg shadow-sm opacity-70">
                                        <p class="font-bold text-blue-950">${isGroup ? 'Group' : '1-on-1'} with ${tutor.name}</p>
                                        <p class="text-sm font-semibold text-gray-800">Topic: ${s.topic || 'N/A'}</p>
                                        <p class="text-sm text-gray-700">${sessionDate}</p>
                                    </div>`;
                    }).join('') + '</div>';
                } else {
                    pastList.innerHTML = `<p class="text-gray-500 p-4">No past sessions.</p>`;
                }

                // Render available group sessions for student to join
                const availableGroupList = document.getElementById('available-group-session-list');
                const availableGroupSessions = db.groupSessions.filter(gs => new Date(gs.date) > now && !gs.participants.includes(currentUser.uid) && !(gs.requests || []).includes(currentUser.uid));

                if (availableGroupSessions.length > 0) {
                    availableGroupList.innerHTML = availableGroupSessions.map(s => {
                        const tutor = db.users[s.tutorId];
                        return `<div class="bg-white p-4 rounded-lg shadow">
                                        <h5 class="font-bold text-blue-950">${s.topic}</h5>
                                        <p class="text-sm text-gray-600">with ${tutor.name}</p>
                                        <p class="text-sm text-gray-600">${new Date(s.date).toLocaleString()}</p>
                                        <p class="text-sm text-gray-600">${s.participants.length}/${s.maxParticipants} spots filled</p>
                                        <button class="btn request-join-btn mt-2 w-full bg-blue-500 text-white text-sm py-1" data-session-id="${s.id}">Request to Join</button>
                                    </div>`;
                    }).join('');
                } else {
                    availableGroupList.innerHTML = `<p class="text-gray-500 col-span-full">No new group sessions available to join.</p>`
                }
            }
        }

        // ======================== CHAT LOGIC ========================
        function renderChatContacts() {
            chatContactsContainer.innerHTML = '';
            const otherUsers = Object.values(db.users).filter(u => u.uid !== currentUser.uid && u.status === 'approved');
            const userUids = Object.keys(db.users);

            // Re-sort users based on most recent message, if available
            const sortedUsers = otherUsers.sort((a, b) => {
                const chatKeyA = [currentUser.uid, a.uid].sort().join('--');
                const chatKeyB = [currentUser.uid, b.uid].sort().join('--');
                const lastMessageA = db.chats[chatKeyA] ? db.chats[chatKeyA][db.chats[chatKeyA].length - 1] : null;
                const lastMessageB = db.chats[chatKeyB] ? db.chats[chatKeyB][db.chats[chatKeyB].length - 1] : null;

                if (lastMessageA && lastMessageB) {
                    return new Date(lastMessageB.createdAt) - new Date(lastMessageA.createdAt);
                }
                if (lastMessageA) return -1;
                if (lastMessageB) return 1;
                return a.name.localeCompare(b.name);
            });

            sortedUsers.forEach(user => {
                const contactEl = document.createElement('div');
                const chatKey = [currentUser.uid, user.uid].sort().join('--');
                const unreadCount = db.unreadCounts[chatKey] || 0;

                contactEl.className = 'chat-contact p-4 cursor-pointer border-b border-gray-200 flex items-center justify-between gap-4 transition-colors hover:bg-gray-100';
                contactEl.dataset.uid = user.uid;

                let unreadBadge = '';
                if (unreadCount > 0) {
                    unreadBadge = `<span class="bg-red-500 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center">${unreadCount}</span>`;
                }

                contactEl.innerHTML = `
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">${user.avatar}</div>
                                    <div>${user.name}</div>
                                </div>
                                ${unreadBadge}
                            `;

                contactEl.addEventListener('click', () => {
                    currentChatPartner = user;
                    document.querySelectorAll('.chat-contact').forEach(c => c.classList.remove('bg-gray-200'));
                    contactEl.classList.add('bg-gray-200');
                    chatHeader.querySelector('span').textContent = `Chat with ${user.name}`;
                    chatInputForm.classList.remove('hidden');

                    const chatHeaderButtons = document.getElementById('chat-header-buttons');
                    if (currentUser.role === 'student' && currentChatPartner.role === 'tutor') {
                        chatHeaderButtons.innerHTML = `
                                <button class="btn join-session-btn bg-blue-500 text-white text-xs py-1 px-2" data-session-type="one-on-one" data-tutor-id="${currentChatPartner.uid}">Start Video Call</button>
                                <button class="btn leave-review-btn bg-green-500 text-white text-xs py-1 px-2">Leave a Review</button>`;
                    } else {
                        chatHeaderButtons.innerHTML = '';
                    }
                    // Clear unread count for this chat
                    if (db.unreadCounts[chatKey]) {
                        delete db.unreadCounts[chatKey];
                        saveState();
                    }
                    renderChatContacts(); // Rerender to remove the badge
                    renderMessages();
                });
                chatContactsContainer.appendChild(contactEl);
            });

            renderGroupChatContacts();
        }

        function renderGroupChatContacts() {
            groupChatContactsContainer.innerHTML = '';
            let userGroups = [];

            // 1. Add general "My Students Group" for tutors
            if (currentUser.role === 'tutor') {
                userGroups.push({
                    id: `tutor-${currentUser.uid}-group`,
                    name: "My Students Group",
                    isSession: false,
                    icon: 'fas fa-users'
                });
            }

            // 2. Add general "Tutor's Group" for students
            if (currentUser.role === 'student') {
                for (const tutorId in db.tutorStudents) {
                    if (db.tutorStudents[tutorId].includes(currentUser.uid)) {
                        const tutor = db.users[tutorId];
                        userGroups.push({
                            id: `tutor-${tutorId}-group`,
                            name: `${tutor.name}'s Group`,
                            isSession: false,
                            icon: 'fas fa-users'
                        });
                    }
                }
            }

            // 3. Add all relevant session-based groups
            const relevantSessions = db.groupSessions.filter(gs =>
                gs.tutorId === currentUser.uid || // Tutor is hosting
                gs.participants.includes(currentUser.uid) // Student is a participant
            );

            relevantSessions.forEach(session => {
                // Prevent duplicates if a tutor is somehow also a participant
                if (!userGroups.some(g => g.id === session.id)) {
                    userGroups.push({
                        id: session.id,
                        name: `Session: ${session.topic}`,
                        isSession: true,
                        icon: 'fas fa-chalkboard-teacher'
                    });
                }
            });

            // 4. Render all collected groups
            if (userGroups.length === 0) {
                groupChatContactsContainer.innerHTML = `<p class="p-4 text-sm text-gray-500">No group chats available.</p>`;
                return;
            }

            userGroups.forEach(group => {
                const groupEl = document.createElement('div');
                groupEl.className = 'chat-contact p-4 cursor-pointer border-b border-gray-200 flex items-center justify-between gap-4 transition-colors hover:bg-gray-100';
                groupEl.dataset.groupId = group.id;
                groupEl.dataset.isSession = group.isSession;

                groupEl.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-purple-500 text-white flex items-center justify-center font-bold"><i class="${group.icon}"></i></div>
                            <div>${group.name}</div>
                        </div>
                    `;

                groupEl.addEventListener('click', () => {
                    currentChatPartner = { uid: group.id, name: group.name, isGroup: true, isSession: group.isSession };
                    document.querySelectorAll('.chat-contact').forEach(c => c.classList.remove('bg-gray-200'));
                    groupEl.classList.add('bg-gray-200');
                    chatHeader.querySelector('span').textContent = `Chat with ${group.name}`;
                    document.getElementById('chat-header-buttons').innerHTML = '';
                    chatInputForm.classList.remove('hidden');
                    renderMessages();
                });
                groupChatContactsContainer.appendChild(groupEl);
            });
        }

        function renderMessages() {
            chatDisplay.innerHTML = '';
            if (!currentUser || !currentChatPartner) {
                chatDisplay.innerHTML = `<p class="text-center text-gray-500 mt-5">Select a contact to start chatting.</p>`;
                return;
            }

            let messages = [];
            if (currentChatPartner.isGroup) {
                const groupId = currentChatPartner.uid;
                if (currentChatPartner.isSession) {
                    const session = db.groupSessions.find(s => s.id === groupId);
                    messages = session ? session.chat || [] : [];
                } else {
                    messages = db.groupChats[groupId] || [];
                }
            } else {
                const chatKey = [currentUser.uid, currentChatPartner.uid].sort().join('--');
                messages = db.chats[chatKey] || [];
            }


            if (messages.length === 0) {
                chatDisplay.innerHTML = `<p class="text-center text-gray-500 mt-5">No messages yet. Say hello!</p>`;
            } else {
                messages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt)).forEach(msg => {
                    const isSent = msg.senderId === currentUser.uid;
                    const sender = db.users[msg.senderId];
                    const messageDiv = document.createElement('div');

                    let senderName = '';
                    if (currentChatPartner.isGroup && !isSent) {
                        senderName = `<div class="text-xs font-bold text-gray-500 mb-1">${sender.name}</div>`;
                    }

                    messageDiv.innerHTML = `${senderName}<div>${msg.text}</div>`;

                    messageDiv.classList.add('p-3', 'rounded-xl', 'max-w-[70%]', 'break-words', 'mb-2');
                    if (isSent) {
                        messageDiv.classList.add('bg-blue-500', 'text-white', 'self-end', 'rounded-br-none');
                    } else {
                        messageDiv.classList.add('bg-gray-200', 'text-gray-800', 'self-start', 'rounded-bl-none');
                    }
                    chatDisplay.appendChild(messageDiv);
                });
            }
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
        }

        function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('chat-message-input');
            const messageText = input.value.trim();
            if (!messageText || !currentUser || !currentChatPartner) return;

            const newMessage = {
                text: messageText,
                senderId: currentUser.uid,
                createdAt: new Date().toISOString()
            };

            if (currentChatPartner.isGroup) {
                const groupId = currentChatPartner.uid;
                if (currentChatPartner.isSession) {
                    const session = db.groupSessions.find(s => s.id === groupId);
                    if (session) {
                        if (!session.chat) session.chat = [];
                        session.chat.push(newMessage);
                    }
                } else {
                    if (!db.groupChats[groupId]) {
                        db.groupChats[groupId] = [];
                    }
                    db.groupChats[groupId].push(newMessage);
                }
            } else {
                const chatKey = [currentUser.uid, currentChatPartner.uid].sort().join('--');
                if (!db.chats[chatKey]) {
                    db.chats[chatKey] = [];
                }
                db.chats[chatKey].push(newMessage);
                const recipientUid = currentChatPartner.uid;
                const recipientChatKey = [recipientUid, currentUser.uid].sort().join('--');
                db.unreadCounts[recipientChatKey] = (db.unreadCounts[recipientChatKey] || 0) + 1;
            }


            saveState();
            renderMessages();
            renderChatContacts();
            input.value = '';
        }

        // ======================== AI TUTOR LOGIC ========================
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const aiChatDisplay = document.getElementById('ai-chat-display');
        const aiInputForm = document.getElementById('ai-input-form');
        const aiMessageInput = document.getElementById('ai-message-input');

        function renderAITutorUI() {
            apiKeyInput.value = db.apiKey || '';
            if (db.apiKey) {
                aiInputForm.classList.remove('hidden');
                renderAITutorMessages();
            } else {
                aiInputForm.classList.add('hidden');
            }
        }

        function renderAITutorMessages() {
            aiChatDisplay.innerHTML = '';
            const messages = db.aiTutorConversations[currentUser.uid] || [];
            if (messages.length === 0) {
                aiChatDisplay.innerHTML = `<p class="text-center text-gray-500 mt-5">Hello! How can I help you today? Please enter your API key to begin.</p>`;
            } else {
                messages.forEach(msg => {
                    const isSent = msg.role === 'user';
                    const messageDiv = document.createElement('div');
                    messageDiv.textContent = msg.text;
                    messageDiv.classList.add('p-3', 'rounded-xl', 'max-w-[70%]', 'break-words', 'mb-2');
                    if (isSent) {
                        messageDiv.classList.add('bg-green-500', 'text-white', 'self-end', 'rounded-br-none');
                    } else {
                        messageDiv.classList.add('bg-gray-200', 'text-gray-800', 'self-start', 'rounded-bl-none');
                    }
                    aiChatDisplay.appendChild(messageDiv);
                });
            }
            aiChatDisplay.scrollTop = aiChatDisplay.scrollHeight;
        }

        async function sendAITutorMessage(e) {
            e.preventDefault();
            const messageText = aiMessageInput.value.trim();
            if (!messageText) return;

            const apiKey = db.apiKey;
            if (!apiKey) {
                showAlert('Please save your API key first.');
                return;
            }

            const userMessage = { role: 'user', text: messageText };
            if (!db.aiTutorConversations[currentUser.uid]) {
                db.aiTutorConversations[currentUser.uid] = [];
            }
            db.aiTutorConversations[currentUser.uid].push(userMessage);

            aiMessageInput.value = '';
            renderAITutorMessages();

            // Add a loading indicator
            const loadingIndicator = document.createElement('div');
            loadingIndicator.textContent = 'AI is thinking...';
            loadingIndicator.classList.add('p-3', 'rounded-xl', 'max-w-[70%]', 'break-words', 'mb-2', 'bg-gray-200', 'text-gray-800', 'self-start', 'rounded-bl-none', 'animate-pulse');
            aiChatDisplay.appendChild(loadingIndicator);
            aiChatDisplay.scrollTop = aiChatDisplay.scrollHeight;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: messageText }] }],
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    throw new Error(`API call failed: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const generatedText = result.candidates[0].content.parts[0].text;
                const aiMessage = { role: 'assistant', text: generatedText };

                db.aiTutorConversations[currentUser.uid].push(aiMessage);
                saveState();

            } catch (error) {
                console.error('API Error:', error);
                showAlert('An error occurred while fetching the AI response. Please check your API key and try again.');
            } finally {
                // Remove loading indicator and render the new message
                loadingIndicator.remove();
                renderAITutorMessages();
            }
        }

        saveApiKeyBtn.addEventListener('click', () => {
            const apiKey = apiKeyInput.value.trim();
            if (apiKey) {
                db.apiKey = apiKey;
                saveState();
                showAlert('API Key saved successfully!');
                renderAITutorUI();
            } else {
                showAlert('Please enter a valid API key.');
            }
        });

        // ======================== AGORA VIDEO CALL LOGIC ========================
        const AGORA_CHANNEL = "DubeSTEMMasteryCall";
        let client = null;
        let localTracks = { videoTrack: null, audioTrack: null };
        let isCallActive = false;
        let isMicOn = true;
        let isCamOn = true;

        const localPlayerContainer = document.getElementById('local-player-container');
        const remotePlayerContainer = document.getElementById('remote-player-container');
        const joinCallBtn = document.getElementById('join-call-btn');
        const leaveCallBtn = document.getElementById('leave-call-btn');
        const toggleMicBtn = document.getElementById('toggle-mic-btn');
        const toggleCamBtn = document.getElementById('toggle-cam-btn');
        const callStatusEl = document.getElementById('call-status');

        function renderVideoCallPage() {
            const sessionContextHeader = document.getElementById('session-context-header');
            const sessionChatContainer = document.getElementById('session-chat-container');

            agoraKeyInput.value = db.agoraKey || '';

            if (currentSessionContext) {
                let session;
                if (currentSessionContext.type === 'group') {
                    session = db.groupSessions.find(s => s.id === currentSessionContext.id);
                    sessionChatContainer.classList.remove('hidden');
                    renderSessionChat();
                } else {
                    session = db.sessions.find(s => s.id === currentSessionContext.id);
                    sessionChatContainer.classList.add('hidden');
                }
                sessionContextHeader.textContent = `Session Topic: ${session.topic}`;
            } else {
                sessionContextHeader.textContent = 'No active session.';
                sessionChatContainer.classList.add('hidden');
            }
            updateVideoControlUI();
        }

        function renderSessionChat() {
            const display = document.getElementById('session-chat-display');
            display.innerHTML = '';
            if (!currentSessionContext || currentSessionContext.type !== 'group') return;

            const session = db.groupSessions.find(s => s.id === currentSessionContext.id);
            if (!session || !session.chat) return;

            if (session.chat.length === 0) {
                display.innerHTML = `<p class="text-center text-gray-500 mt-5 text-sm">Welcome to the session chat!</p>`;
            } else {
                session.chat.forEach(msg => {
                    const isSent = msg.senderId === currentUser.uid;
                    const sender = db.users[msg.senderId];
                    const messageDiv = document.createElement('div');

                    let senderName = isSent ? '' : `<div class="text-xs font-bold text-gray-500 mb-1">${sender.name}</div>`;

                    messageDiv.innerHTML = `${senderName}<div>${msg.text}</div>`;
                    messageDiv.classList.add('p-2', 'rounded-lg', 'max-w-[85%]', 'break-words', 'mb-2', 'text-sm');

                    if (isSent) {
                        messageDiv.classList.add('bg-blue-500', 'text-white', 'self-end', 'rounded-br-none');
                    } else {
                        messageDiv.classList.add('bg-gray-200', 'text-gray-800', 'self-start', 'rounded-bl-none');
                    }
                    display.prepend(messageDiv);
                });
            }
        }

        function sendSessionChatMessage(e) {
            e.preventDefault();
            if (!currentSessionContext || currentSessionContext.type !== 'group') return;
            const input = document.getElementById('session-chat-input');
            const messageText = input.value.trim();
            if (!messageText) return;

            const session = db.groupSessions.find(s => s.id === currentSessionContext.id);
            if (session) {
                const newMessage = { senderId: currentUser.uid, text: messageText, createdAt: new Date().toISOString() };
                if (!session.chat) session.chat = [];
                session.chat.push(newMessage);
                saveState();
                renderSessionChat();
                input.value = '';
            }
        }


        saveAgoraKeyBtn.addEventListener('click', () => {
            const agoraKey = agoraKeyInput.value.trim();
            if (agoraKey) {
                db.agoraKey = agoraKey;
                saveState();
                showAlert('Agora App ID saved successfully!');
                renderVideoCallPage();
            } else {
                showAlert('Please enter a valid Agora App ID.');
            }
        });


        async function initAgora() {
            if (client) return; // Prevent re-initialization
            try {
                client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
                client.on("user-published", async (user, mediaType) => {
                    await client.subscribe(user, mediaType);
                    if (mediaType === "video") {
                        remotePlayerContainer.querySelector('.pointer-events-none').classList.add('hidden');
                        user.videoTrack.play('remote-player-container');
                    }
                    if (mediaType === "audio") user.audioTrack.play();
                });
                client.on("user-unpublished", (user, mediaType) => {
                    if (mediaType === 'video') {
                        user.videoTrack.stop();
                        remotePlayerContainer.querySelector('.pointer-events-none').classList.remove('hidden');
                    }
                });
            } catch (error) {
                console.error("Agora initialization failed:", error);
            }
        }

        async function joinCall() {
            if (!db.agoraKey) {
                showAlert('Please save your Agora App ID before starting a call.');
                return;
            }
            if (isCallActive) return;
            await initAgora();
            callStatusEl.textContent = 'Connecting...';
            try {
                // In a real app, a token would be generated on the server
                const channelName = currentSessionContext ? currentSessionContext.id : 'default-channel';
                await client.join(db.agoraKey, channelName, null, currentUser.uid);
                localTracks.audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
                localTracks.videoTrack = await AgoraRTC.createCameraVideoTrack();
                await client.publish(Object.values(localTracks));

                localPlayerContainer.querySelector('.pointer-events-none').classList.add('hidden');
                localTracks.videoTrack.play('local-player-container');
                isCallActive = true;
                callStatusEl.textContent = 'Connected. Waiting for others...';
                updateVideoControlUI();
            } catch (error) {
                console.error("Failed to join Agora channel", error);
                showAlert("Could not start video call. Please check camera/microphone permissions.");
                callStatusEl.textContent = 'Video call is not active.';
            }
        }

        async function leaveCall() {
            if (!isCallActive) return;
            for (let track in localTracks) {
                if (localTracks[track]) {
                    localTracks[track].stop();
                    localTracks[track].close();
                    localTracks[track] = null;
                }
            }
            await client.leave();
            isCallActive = false;
            localPlayerContainer.querySelector('.pointer-events-none').classList.remove('hidden');
            remotePlayerContainer.querySelector('.pointer-events-none').classList.remove('hidden');
            callStatusEl.textContent = 'Video call is not active.';
            updateVideoControlUI();
        }

        async function toggleMic() {
            if (!localTracks.audioTrack) return;
            isMicOn = !isMicOn;
            await localTracks.audioTrack.setEnabled(isMicOn);
            updateVideoControlUI();
        }

        async function toggleCamera() {
            if (!localTracks.videoTrack) return;
            isCamOn = !isCamOn;
            await localTracks.videoTrack.setEnabled(isCamOn);
            updateVideoControlUI();
        }

        function updateVideoControlUI() {
            const isKeyPresent = !!db.agoraKey;
            joinCallBtn.disabled = !isKeyPresent;

            if (isKeyPresent) {
                joinCallBtn.classList.remove('cursor-not-allowed', 'bg-gray-400');
                joinCallBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            } else {
                joinCallBtn.classList.add('cursor-not-allowed', 'bg-gray-400');
                joinCallBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            }

            joinCallBtn.classList.toggle('hidden', isCallActive);
            leaveCallBtn.classList.toggle('hidden', !isCallActive);
            toggleMicBtn.classList.toggle('hidden', !isCallActive);
            toggleCamBtn.classList.toggle('hidden', !isCallActive);

            toggleMicBtn.innerHTML = isMicOn ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
            toggleMicBtn.classList.toggle('bg-green-500', isMicOn);
            toggleMicBtn.classList.toggle('bg-red-500', !isMicOn);
            toggleCamBtn.innerHTML = isCamOn ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
            toggleCamBtn.classList.toggle('bg-green-500', isCamOn);
            toggleCamBtn.classList.toggle('bg-red-500', !isCamOn);
            leaveCallBtn.classList.add('bg-red-500');
        }

        function renderResources() {
            const resourcesContainer = document.getElementById('resources-content');
            resourcesContainer.innerHTML = '';

            const userModules = currentUser.modules || [];
            const modulesToShow = [...userModules, 'General'];
            let resourcesHTML = '';

            modulesToShow.forEach(module => {
                const moduleResources = db.resources[module] || [];
                moduleResources.forEach(resource => {
                    resourcesHTML += `
                                <div class="resource-card bg-gray-100 rounded-lg overflow-hidden shadow-md hover:translate-y-[-5px] transition-transform duration-300">
                                    <div class="h-40 bg-gray-300 flex items-center justify-center">
                                        <i class="${resource.icon} text-5xl text-gray-500"></i>
                                    </div>
                                    <div class="p-4">
                                        <div class="font-semibold text-lg text-blue-950">${resource.title}</div>
                                        <div class="text-sm text-gray-600 mt-1">${resource.desc}</div>
                                        <a href="${resource.link}" class="inline-block mt-4 text-blue-500 font-semibold hover:underline" target="_blank">View Resource</a>
                                    </div>
                                </div>
                                `;
                });
            });

            if (resourcesHTML) {
                resourcesContainer.innerHTML = resourcesHTML;
            } else {
                resourcesContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">No resources available for your selected modules yet. Please check back later.</p>`;
            }
        }

        // ======================== INITIALIZATION & EVENT LISTENERS ========================
        function init() {
            document.getElementById('current-year').textContent = new Date().getFullYear();
            loadState();

            // Check for a logged-in user on app start
            const savedUser = localStorage.getItem(CURRENT_USER_KEY);
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                setupUIForLogin();
            } else {
                // Show the public-facing homepage
                mainContentSections.forEach(el => el.classList.remove('hidden'));
                dashboard.classList.add('hidden');
                loginLink.classList.remove('hidden');
                renderTutors();
            }
            renderSeededUserLogins();

            // UI interactions
            document.getElementById('login-link').addEventListener('click', (e) => {
                e.preventDefault();
                authModal.classList.add('flex');
                document.querySelector('.auth-tab[data-tab="login"]').click(); // Ensure login tab is active
            });

            // Event delegation for closing modals
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('close-modal')) {
                    e.target.closest('.modal').classList.remove('flex');
                }
            });

            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabId = this.dataset.tab;
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active', 'border-blue-500'));
                    this.classList.add('active', 'border-blue-500');
                    document.querySelectorAll('.auth-form').forEach(form => {
                        form.classList.toggle('hidden', form.id !== `${tabId}-form`);
                    });
                });
            });
            document.querySelector('.auth-tab[data-tab="login"]').classList.add('active', 'border-blue-500');
            document.getElementById('login-form').classList.remove('hidden');

            document.getElementById('login-form').addEventListener('submit', function (e) {
                e.preventDefault();
                handleLogin(document.getElementById('login-email').value);
            });

            // Handle role selection to show/hide module and document upload fields
            signupRoleSelect.addEventListener('change', function () {
                const role = this.value;
                if (role === 'tutor') {
                    roleSpecificSignupSection.classList.remove('hidden');
                    roleSpecificSignupSection.innerHTML = `
                                    <p class="text-sm text-gray-600 mb-2 font-semibold">Select the modules you teach:</p>
                                    <div class="flex flex-wrap gap-4 mb-4">
                                        ${modulesList.map(module => `<label class="inline-flex items-center"><input type="checkbox" name="modules" value="${module}" class="form-checkbox"><span class="ml-2">${module}</span></label>`).join('')}
                                    </div>
                                    <p class="text-sm text-gray-600 mb-2 font-semibold">Select your teaching level:</p>
                                    <select id="tutor-level" required class="w-full p-3 border border-gray-300 rounded-lg bg-white mb-4">
                                        <option value="">Select level...</option>
                                        <option value="High school level">High school level</option>
                                        <option value="Varsity level">Varsity level</option>
                                        <option value="Both">Both</option>
                                    </select>
                                    <p class="text-sm text-gray-600 mb-2 font-semibold">Please upload your documents:</p>
                                    <div class="mb-2">
                                        <label for="user-documents" class="block text-sm font-medium text-gray-700">Transcript, Qualifications & Results</label>
                                        <input type="file" id="user-documents" multiple required class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                                    </div>
                                `;
                } else if (role === 'student') {
                    roleSpecificSignupSection.classList.remove('hidden');
                    roleSpecificSignupSection.innerHTML = `
                                    <p class="text-sm text-gray-600 mb-2 font-semibold">Select the modules you need help with:</p>
                                    <div class="flex flex-wrap gap-4 mb-4">
                                        ${modulesList.map(module => `<label class="inline-flex items-center"><input type="checkbox" name="modules" value="${module}" class="form-checkbox"><span class="ml-2">${module}</span></label>`).join('')}
                                    </div>
                                    <p class="text-sm text-gray-600 mb-2 font-semibold">Select your grade level:</p>
                                    <select id="student-level" required class="w-full p-3 border border-gray-300 rounded-lg bg-white mb-4">
                                        <option value="">Select level...</option>
                                        <option value="Grade 9">Grade 9</option>
                                        <option value="Grade 10">Grade 10</option>
                                        <option value="Grade 11">Grade 11</option>
                                        <option value="Grade 12">Grade 12</option>
                                        <option value="University - 1st Year">University - 1st Year</option>
                                        <option value="University - 2nd Year">University - 2nd Year</option>
                                        <option value="University - 3rd Year">University - 3rd Year</option>
                                    </select>
                                    <p class="text-sm text-gray-600 mb-2 font-semibold">Please upload your documents:</p>
                                    <div class="mb-2">
                                        <label for="user-documents" class="block text-sm font-medium text-gray-700">Previous Academic Results</label>
                                        <input type="file" id="user-documents" required class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                                    </div>
                                `;
                } else {
                    roleSpecificSignupSection.classList.add('hidden');
                }
            });

            document.getElementById('signup-form').addEventListener('submit', handleSignup);

            logoutBtn.addEventListener('click', async () => {
                await setupUIForLogout();
            });

            // Dashboard navigation
            document.body.addEventListener('click', function (e) {
                // Event delegation for nav links
                if (e.target.classList.contains('nav-link')) {
                    e.preventDefault();
                    const targetId = e.target.getAttribute('href').substring(1);
                    navLinks.forEach(l => l.classList.remove('active'));
                    const activeLink = Array.from(navLinks).find(l => l.getAttribute('href').substring(1) === targetId);
                    if (activeLink) {
                        activeLink.classList.add('active');
                    }
                    dashboardSections.forEach(section => {
                        section.classList.toggle('hidden', section.id !== targetId);
                    });
                    if (targetId === 'student-management') renderStudentManagement();
                    if (targetId === 'admin-management') renderAdminManagement();
                    if (targetId === 'chat-section') {
                        renderChatContacts();
                        dmTab.click(); // Default to DM tab
                    }
                    if (targetId === 'ai-tutor-section') renderAITutorUI();
                    if (targetId === 'reviews') renderReviews();
                    if (targetId === 'schedule') renderSchedule();
                    if (targetId === 'resources') renderResources();
                    if (targetId === 'video-call') renderVideoCallPage();
                }
            });

            dmTab.addEventListener('click', () => {
                dmTab.classList.add('active');
                groupTab.classList.remove('active');
                chatContactsContainer.classList.remove('hidden');
                groupChatContactsContainer.classList.add('hidden');
            });

            groupTab.addEventListener('click', () => {
                groupTab.classList.add('active');
                dmTab.classList.remove('active');
                groupChatContactsContainer.classList.remove('hidden');
                chatContactsContainer.classList.add('hidden');
            });


            if (studentSelect) {
                studentSelect.addEventListener('change', (e) => {
                    populateTutorSelect(e.target.value);
                });
            }


            // Handle dynamically added buttons
            document.body.addEventListener('click', async function (e) {
                if (e.target.classList.contains('seeded-login-btn')) {
                    const email = e.target.dataset.email;
                    if (email) handleLogin(email);
                } else if (e.target.classList.contains('approve-btn')) {
                    const userId = e.target.dataset.userId;
                    const userToApprove = db.users[userId];
                    if (userToApprove) {
                        userToApprove.status = 'approved';
                        saveState();
                        showAlert(`${userToApprove.name} has been approved.`);
                        renderAdminManagement();
                        renderDashboardContent();
                        renderTutors();
                    }
                } else if (e.target.classList.contains('reject-btn')) {
                    const userId = e.target.dataset.userId;
                    const userToReject = db.users[userId];
                    if (userToReject) {
                        delete db.users[userId];
                        saveState();
                        showAlert(`${userToReject.name} has been rejected and removed.`);
                        renderAdminManagement();
                        renderDashboardContent();
                        renderTutors();
                    }
                } else if (e.target.classList.contains('remove-student-btn')) {
                    const studentId = e.target.dataset.studentId;
                    const tutorStudents = db.tutorStudents[currentUser.uid];
                    if (tutorStudents) {
                        const index = tutorStudents.indexOf(studentId);
                        if (index > -1) {
                            tutorStudents.splice(index, 1);
                            saveState();
                            showAlert(`Student removed.`);
                            renderStudentManagement();
                        }
                    }
                } else if (e.target.classList.contains('message-student-btn')) {
                    const studentUid = e.target.dataset.studentId;
                    currentChatPartner = db.users[studentUid];
                    document.querySelector('a[href="#chat-section"]').click();
                    renderMessages();
                } else if (e.target.classList.contains('book-session-btn')) {
                    e.preventDefault();
                    if (!currentUser) {
                        showAlert("Please log in or sign up to book a session.");
                        loginLink.click();
                    } else if (currentUser.role !== 'student') {
                        showAlert("Only students can book sessions.");
                    } else {
                        showAlert("To book a one-on-one session, please message a tutor directly to coordinate a time. You can request to join available group sessions on the Schedule page.");
                    }
                } else if (e.target.classList.contains('cancel-session-btn')) {
                    const sessionId = e.target.dataset.sessionId;
                    const sessionType = e.target.dataset.type;
                    if (sessionId) {
                        if (sessionType === 'one-on-one') {
                            db.sessions = db.sessions.filter(s => s.id !== sessionId);
                        } else {
                            db.groupSessions = db.groupSessions.filter(s => s.id !== sessionId);
                        }
                        saveState();
                        showAlert('Session cancelled successfully.');
                        renderSchedule();
                    }
                } else if (e.target.classList.contains('request-join-btn')) {
                    const sessionId = e.target.dataset.sessionId;
                    const session = db.groupSessions.find(s => s.id === sessionId);
                    if (session) {
                        if (!session.requests) session.requests = [];
                        session.requests.push(currentUser.uid);
                        saveState();
                        showAlert('Your request to join has been sent.');
                        renderSchedule();
                    }
                } else if (e.target.classList.contains('approve-request-btn')) {
                    const { sessionId, studentId } = e.target.dataset;
                    const session = db.groupSessions.find(s => s.id === sessionId);
                    if (session && session.participants.length < session.maxParticipants) {
                        session.requests = session.requests.filter(id => id !== studentId);
                        session.participants.push(studentId);
                        saveState();
                        showAlert('Request approved.');
                        renderSchedule();
                    } else {
                        showAlert('Could not approve. The session might be full.');
                    }
                } else if (e.target.classList.contains('decline-request-btn')) {
                    const { sessionId, studentId } = e.target.dataset;
                    const session = db.groupSessions.find(s => s.id === sessionId);
                    if (session) {
                        session.requests = session.requests.filter(id => id !== studentId);
                        saveState();
                        showAlert('Request declined.');
                        renderSchedule();
                    }
                } else if (e.target.classList.contains('join-session-btn')) {
                    currentSessionContext = {
                        id: e.target.dataset.sessionId,
                        type: e.target.dataset.sessionType,
                    };
                    if (e.target.dataset.tutorId) { // From chat header, find the session
                        const now = new Date();
                        const upcomingSession = db.sessions.find(s => s.studentId === currentUser.uid && s.tutorId === e.target.dataset.tutorId && new Date(s.date) > now);
                        if (upcomingSession) {
                            currentSessionContext.id = upcomingSession.id;
                        } else {
                            showAlert("No upcoming session with this tutor. Please schedule one first.");
                            return;
                        }
                    }
                    document.querySelector('a[href="#video-call"]').click();
                } else if (e.target.classList.contains('schedule-tab')) {
                    const tab = e.target.dataset.tab;
                    document.querySelectorAll('.schedule-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelectorAll('.schedule-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(`student-${tab}-list`).classList.remove('hidden');
                } else if (e.target.classList.contains('view-docs-btn')) {
                    const userId = e.target.dataset.userId;
                    const user = db.users[userId];
                    const docsModal = document.getElementById('docs-modal');
                    const docsModalUser = document.getElementById('docs-modal-user');
                    const docsList = document.getElementById('docs-list');

                    if (user && user.documents && user.documents.length > 0) {
                        docsModalUser.textContent = `Showing documents for: ${user.name}`;
                        docsList.innerHTML = user.documents.map(doc =>
                            `<div class="bg-gray-100 p-3 rounded-lg flex items-center gap-3">
                                    <i class="fas fa-file-alt text-gray-500"></i>
                                    <span class="font-semibold text-gray-700">${doc}</span>
                                    <a href="#" class="ml-auto text-blue-500 hover:underline text-sm" onclick="event.preventDefault(); showAlert('This is a simulated document view.')">View</a>
                                </div>`
                        ).join('');
                        docsModal.classList.add('flex');
                    } else {
                        showAlert('No documents found for this user.');
                    }
                }
            });

            // Handle event delegation for the "Leave a Review" button
            document.getElementById('chat-header-buttons').addEventListener('click', (e) => {
                if (e.target.classList.contains('leave-review-btn')) {
                    if (currentChatPartner && currentChatPartner.role === 'tutor') {
                        reviewModalUser.textContent = `You are reviewing: ${currentChatPartner.name}`;
                        reviewModal.classList.add('flex');
                        reviewForm.reset();
                        reviewStars.forEach(s => {
                            s.classList.remove('fas');
                            s.classList.add('far');
                        });
                    } else {
                        showAlert('You can only leave reviews for tutors.');
                    }
                }
            });


            // Handle event delegation for submitting the review form
            reviewForm.addEventListener('submit', function (e) {
                e.preventDefault();
                if (!currentChatPartner || currentChatPartner.role !== 'tutor') {
                    showAlert('You can only leave reviews for tutors.');
                    return;
                }

                const rating = parseInt(reviewRatingInput.value);
                const comment = document.getElementById('review-comment').value.trim();

                if (!rating || !comment) {
                    showAlert('Please provide a rating and a comment.');
                    return;
                }

                const existingReview = db.reviews.find(r => r.reviewerId === currentUser.uid && r.reviewedId === currentChatPartner.uid);
                if (existingReview) {
                    showAlert(`You have already reviewed ${currentChatPartner.name}.`);
                    return;
                }

                const newReview = {
                    reviewerId: currentUser.uid,
                    reviewedId: currentChatPartner.uid,
                    rating: rating,
                    comment: comment,
                    timestamp: new Date().toISOString()
                };
                db.reviews.push(newReview);
                saveState();

                showAlert(`Thank you for your review of ${currentChatPartner.name}!`);
                reviewModal.classList.remove('flex');
                reviewForm.reset();
                renderReviews();
                renderTutors();
            });

            // Chat input listener
            document.getElementById('chat-input-form').addEventListener('submit', sendMessage);
            document.getElementById('session-chat-form').addEventListener('submit', sendSessionChatMessage);
            document.getElementById('ai-input-form').addEventListener('submit', sendAITutorMessage);


            // Video call listeners
            joinCallBtn.addEventListener('click', () => {
                joinCall();
            });
            leaveCallBtn.addEventListener('click', () => {
                leaveCall();
            });
            toggleMicBtn.addEventListener('click', () => {
                toggleMic();
            });
            toggleCamBtn.addEventListener('click', () => {
                toggleCamera();
            });


            scheduleForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const date = document.getElementById('schedule-date').value;
                const time = document.getElementById('schedule-time').value;
                const proposedDateTime = `${date}T${time}`;

                if (currentUser.role !== 'tutor') {
                    // This form is now hidden for students, so this check is a safeguard.
                    return;
                }

                const sessionType = document.getElementById('session-type').value;
                if (sessionType === 'one-on-one') {
                    const studentId = document.getElementById('schedule-student-select').value;
                    const topic = document.getElementById('one-on-one-topic').value;
                    const notes = document.getElementById('tutor-schedule-notes').value;
                    if (!studentId) { showAlert("Please select a student."); return; }
                    if (!topic) { showAlert("Please enter a topic."); return; }

                    const conflict = db.sessions.find(s => s.date === proposedDateTime && (s.tutorId === currentUser.uid || s.studentId === studentId));
                    if (conflict) { showAlert('A session is already scheduled at this time for you or the selected student.'); return; }

                    db.sessions.push({ id: `sess${Date.now()}`, studentId, tutorId: currentUser.uid, date: proposedDateTime, topic, notes });
                    showAlert('One-on-one session scheduled!');

                } else { // Group session
                    const topic = document.getElementById('group-topic').value;
                    const maxParticipants = document.getElementById('max-participants').value;
                    if (!topic) { showAlert("Please enter a topic for the group session."); return; }

                    db.groupSessions.push({ id: `group${Date.now()}`, tutorId: currentUser.uid, topic, date: proposedDateTime, maxParticipants, participants: [], requests: [], chat: [] });
                    showAlert('Group session created!');
                }

                saveState();
                scheduleForm.reset();
                renderSchedule();
            });

            // Intersectional Observer for fade-in animations
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('appear');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.fade-in').forEach(section => observer.observe(section));
        }

        function renderSeededUserLogins() {
            const container = document.getElementById('seeded-users-buttons');
            const seededEmails = [
                'mrdube@system.com',
                'alice@tutor.com',
                'pending.tutor@test.com',
                'student1@test.com',
                'pending.student@test.com'
            ];

            const buttonsHTML = seededEmails.map(email => {
                const user = db.users[email];
                return `<button class="seeded-login-btn btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-full text-sm" data-email="${user.email}" title="${user.email}">
                                ${user.name.split(' ')[0]} (${user.role})
                            </button>`;
            }).join('');
            container.innerHTML = buttonsHTML;
        }

        init();
    </script>
</body>
</html>


